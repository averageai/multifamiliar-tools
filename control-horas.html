<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Horas de Empleados</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f0f;
            font-size: 13px;
            line-height: 1.4;
            color: #ffffff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #1a1a1a;
            min-height: 100vh;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 12px 20px;
            border-bottom: 3px solid #3498db;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .back-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .logo {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
        }

        .header-text {
            flex: 1;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header p {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .content {
            padding: 15px;
        }

        .sede-selector {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .sede-selector h2 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .sede-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .sede-btn {
            background: #333;
            color: #ffffff;
            border: 2px solid #333;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 150px;
        }

        .sede-btn:hover {
            background: #444;
            transform: translateY(-2px);
        }

        .sede-btn.active {
            background: #3498db;
            border-color: #3498db;
            color: white;
        }

        .sede-btn.active:hover {
            background: #2980b9;
            border-color: #2980b9;
        }

        .sede-icon {
            font-size: 24px;
        }

        .main-content {
            display: none;
        }

        .top-bar {
            background: #1e3a2e;
            border: 1px solid #4ade80;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .system-info {
            font-weight: 600;
            color: #4ade80;
        }

        .stats-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .stat-chip {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .input-section {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .input-section h2 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 16px;
            text-align: center;
        }

        .input-form {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 12px;
            color: #a0a0a0;
            font-weight: 600;
        }

        .form-input {
            padding: 8px 12px;
            border: 1px solid #333;
            border-radius: 6px;
            font-size: 12px;
            background: #1a1a1a;
            color: #ffffff;
            min-width: 200px;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            background: #333;
        }

        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: #3498db;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #333;
            display: flex;
            justify-content: flex-end;
        }

        .historial-info {
            background: #2c3e50;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .historial-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #ecf0f1;
        }

        .historial-sesiones {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sesion-item {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }

        .sesion-item:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .sesion-item.sesion-activa {
            border-color: #28a745;
            background: linear-gradient(135deg, #2a2a2a 0%, #1e3a1e 100%);
        }

        .sesion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .sesion-numero {
            font-weight: 600;
            color: #3498db;
            font-size: 14px;
        }

        .sesion-estado {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background: #444;
        }

        .sesion-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sesion-time {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-label {
            font-size: 12px;
            color: #a0a0a0;
            font-weight: 500;
        }

        .time-value {
            font-size: 12px;
            color: #ecf0f1;
            font-weight: 600;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-header {
            background: #2c3e50;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .table-container {
            background: #1a1a1a;
            border: 1px solid #333;
            max-height: 500px;
            overflow-y: auto;
            border-radius: 0 0 8px 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background: #2a2a2a;
            padding: 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 10;
            color: #ffffff;
        }

        td {
            padding: 6px 8px;
            border-bottom: 1px solid #333;
            color: #ffffff;
        }

        tr:hover {
            background: #2a2a2a;
        }

        .status-active {
            background: #1f3d2e !important;
            color: #4ade80;
        }

        .status-finalizado {
            background: #1a1a1a;
        }

        .status-forzado {
            background: #3d1f1f !important;
            color: #ff6b6b;
        }

        .time-badge {
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .duration-badge {
            background: #6f42c1;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }

        .alert {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            border-left: 3px solid #bee5eb;
            font-size: 12px;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            border-left-color: #dc3545;
            font-size: 12px;
        }

        .no-records {
            text-align: center;
            padding: 30px;
            color: #6c757d;
        }

        .summary-info {
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 3px;
            margin-bottom: 15px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-number {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
        }

        .summary-label {
            font-size: 10px;
            color: #6c757d;
            text-transform: uppercase;
        }

        .footer {
            background: #2c3e50;
            color: #a0a0a0;
            text-align: center;
            padding: 15px;
            font-size: 12px;
            margin-top: 30px;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
            color: #ffffff;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .input-form {
                flex-direction: column;
                align-items: stretch;
            }
            
            .form-input {
                min-width: auto;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }

        /* Estilos para sesiones activas */
        .sesiones-info {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .sesiones-info p {
            margin: 5px 0;
            font-size: 14px;
        }

        .sesiones-lista {
            max-height: 400px;
            overflow-y: auto;
        }

        .sesion-activa-item {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
        }

        .sesion-activa-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .sesion-activa-numero {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .sesion-activa-estado {
            color: #28a745;
            font-weight: bold;
            font-size: 14px;
        }

        .sesion-activa-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .sesion-activa-info {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 12px;
            color: #a0a0a0;
            margin-bottom: 2px;
        }

        .info-value {
            font-size: 14px;
            color: #ffffff;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">‚è∞</div>
            <div class="header-text">
                <h1>Control de Horas de Colaboradores</h1>
                <p>Registro de entrada y salida de personal - Multi-Sede</p>
            </div>
            <a href="index.html" class="back-btn">‚Üê Volver al MENU</a>
        </div>

        <div class="content">
            <!-- Selector de Sede -->
            <div class="sede-selector" id="sedeSelector">
                <h2>üè¢ Seleccionar Sede</h2>
                <div class="sede-buttons">
                    <button class="sede-btn" data-sede="1" onclick="seleccionarSede(1, 'Manizales')">
                        <div class="sede-icon">üè™</div>
                        <div>Manizales</div>
                    </button>
                    <button class="sede-btn" data-sede="2" onclick="seleccionarSede(2, 'Dorada')">
                        <div class="sede-icon">üè¨</div>
                        <div>Dorada</div>
                    </button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Conectando con la base de datos...</p>
                <p id="loadingDetail">Inicializando sistema...</p>
            </div>

            <div class="main-content" id="mainContent">
                <div class="top-bar">
                    <div class="system-info">
                        Sistema de Control de Horas - Sede: <span id="sedeInfo">-</span> - <span id="currentTime">Cargando...</span>
                    </div>
                    <div class="stats-chips" id="statsChips">
                        <span class="stat-chip">0 registros</span>
                        <span class="stat-chip">0 activos</span>
                    </div>
                </div>

                <div class="input-section">
                    <h2>üìù Registrar Entrada/Salida</h2>
                    <div class="input-form">
                        <div class="form-group">
                            <label for="documento">Documento de Identidad</label>
                            <input type="text" id="documento" class="form-input" 
                                   placeholder="Ingrese n√∫mero de documento..." 
                                   onkeypress="handleKeyPress(event)">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="validarEmpleado()">‚úÖ Validar Usuario</button>
                        </div>
                        
                        <!-- Secci√≥n de informaci√≥n del empleado (oculta inicialmente) -->
                        <div id="empleadoInfo" style="display: none;">
                            <div class="form-group">
                                <label>Usuario Validado</label>
                                <div id="empleadoNombre" class="form-input" style="background: #2c3e50; color: #fff; font-weight: bold;"></div>
                            </div>
                            <div class="form-group">
                                <label>Estado Actual</label>
                                <div id="empleadoEstado" class="form-input" style="background: #2c3e50; color: #fff;"></div>
                            </div>
                                                         <div class="form-group">
                                 <button class="btn btn-primary" onclick="registrarEntrada()" id="btnEntrada">‚è∞ Registrar Entrada</button>
                                 <button class="btn btn-warning" onclick="registrarSalida()" id="btnSalida">üö™ Registrar Salida</button>
                                 <!-- <button class="btn btn-info" onclick="refrescarEstadoEmpleado()" style="margin-left: 10px;">üîÑ Refrescar Estado</button> -->
                                 <button class="btn btn-secondary" onclick="verHistorialEmpleado()" style="margin-left: 10px;">üìã Ver Historial</button>
                             </div>
                        </div>
                    </div>
                </div>

                <div class="summary-info" id="summaryInfo">
                    <div class="summary-item">
                        <div class="summary-number" id="totalRegistros">0</div>
                        <div class="summary-label">Total Registros</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number" id="empleadosActivos">0</div>
                        <div class="summary-label">Usuarios Activos</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number" id="totalHoras">0</div>
                        <div class="summary-label">Horas Totales</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number" id="promedioHoras">0</div>
                        <div class="summary-label">Promedio Horas</div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <span>Registros de Hoy</span>
                        <div class="action-buttons">
                            <button class="btn" onclick="exportarRegistros()">üìä Exportar Hoy</button>
                            <button class="btn btn-info" onclick="exportarFechaEspecifica()">üìÖ Exportar Fecha</button>
                            <button class="btn btn-warning" onclick="finalizarJornada()">üèÅ Finalizar Jornada</button>
                            <button class="btn btn-success" onclick="mostrarSesionesActivas()">üë• Sesiones Activas</button>
                            <button class="btn btn-danger" onclick="cambiarSede()">üîÑ Cambiar Sede</button>
                        </div>
                    </div>
                    <div class="table-container" id="registrosContainer">
                        <div class="no-records">
                            <h3>üìù Sin registros</h3>
                            <p>Registra la entrada de un usuario para comenzar</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Desarrollado por Humanos + IA en <a href="https://ai.average.lat" target="_blank">average</a></p>
        </div>
    </div>

    <script>
        // ========================================
        // üåç FUNCI√ìN HELPER PARA FECHA/HORA COLOMBIA
        // ========================================
        function getColombiaDateTime() {
            const now = new Date();
            
            // Obtener fecha y hora en timezone de Colombia usando toLocaleString
            const fechaColombia = now.toLocaleDateString("en-CA", {timeZone: "America/Bogota"}); // formato YYYY-MM-DD
            const horaColombia = now.toLocaleTimeString("en-US", {timeZone: "America/Bogota", hour12: false}); // formato HH:MM:SS
            
            // Crear fecha y hora en formato ISO para la base de datos (SIN .000Z para evitar UTC)
            const fecha = fechaColombia; // Ya est√° en formato YYYY-MM-DD
            const hora = `${fechaColombia}T${horaColombia}`; // Formato ISO sin Z para mantener hora de Colombia
            
            return {
                fecha: fecha,
                hora: hora,
                horaLocal: now.toLocaleTimeString('es-CO', {timeZone: "America/Bogota"})
            };
        }

        // ========================================
        // üîß CONFIGURACI√ìN Y VARIABLES GLOBALES
        // ========================================
        let sedeActual = null;
        let sedeNombre = '';
        let registros = [];
        let estadisticas = {
            total_registros: 0,
            empleados_activos: 0,
            horas_totales: 0,
            promedio_horas: 0
        };

        // Configuraci√≥n de la API
        const API_BASE = window.location.origin + '/api';

        // Actualizar hora actual
        function actualizarHora() {
            const horaFormateada = getColombiaDateTime().horaLocal;
            document.getElementById('currentTime').textContent = horaFormateada;
        }

        // Actualizar cada segundo
        setInterval(actualizarHora, 1000);
        actualizarHora();

        // Variables globales para el empleado validado
        let empleadoValidado = null;
        let tieneRegistroActivo = false;
        let procesandoEntrada = false;
        let procesandoSalida = false;

        // Funci√≥n para validar empleado
        async function validarEmpleado() {
            const documento = document.getElementById('documento').value.trim();
            
            if (!documento) {
                mostrarAlerta('‚ö†Ô∏è Por favor ingresa el n√∫mero de documento', 'warning');
                return;
            }

            console.log('üîç Iniciando validaci√≥n de empleado:', documento);

            try {
                // Buscar empleado por documento
                console.log('üîç Buscando empleado en base de datos...');
                const empleadoResponse = await fetch(`${API_BASE}/empleados/${documento}`);
                const empleadoResult = await empleadoResponse.json();
                
                console.log('üîç Resultado b√∫squeda empleado:', empleadoResult);
                
                if (!empleadoResult.success) {
                    mostrarAlerta('‚ùå Empleado no encontrado. Contacta al administrador para registrarte.', 'error');
                    return;
                }

                empleadoValidado = empleadoResult.data;
                console.log('‚úÖ Empleado encontrado:', empleadoValidado);

                // Verificar estado completo del empleado
                await verificarEstadoCompletoEmpleado();

            } catch (error) {
                console.error('‚ùå Error validando empleado:', error);
                mostrarError(`Error: ${error.message}`);
            }
        }

        // Funci√≥n mejorada para verificar estado completo del empleado
        async function verificarEstadoCompletoEmpleado() {
            if (!empleadoValidado) {
                console.log('‚ùå No hay empleado validado para verificar');
                return;
            }
            
            console.log('üîÑ Verificando estado completo del empleado:', empleadoValidado.documento);
            
            try {
                const { fecha } = getColombiaDateTime();
                
                // 1. Verificar registro activo
                console.log('üîç 1. Verificando registro activo...');
                const activoResponse = await fetch(`${API_BASE}/registros/activo/${empleadoValidado.documento}?fecha=${fecha}`);
                const activoResult = await activoResponse.json();
                
                console.log('üîç Resultado verificaci√≥n activo:', activoResult);
                
                // 2. Obtener √∫ltimo registro del d√≠a
                console.log('üîç 2. Obteniendo √∫ltimo registro del d√≠a...');
                const ultimoResponse = await fetch(`${API_BASE}/registros/ultimo/${empleadoValidado.documento}?fecha=${fecha}`);
                const ultimoResult = await ultimoResponse.json();
                
                console.log('üîç Resultado √∫ltimo registro:', ultimoResult);
                
                // 3. Obtener todos los registros de hoy para verificar consistencia
                console.log('üîç 3. Verificando consistencia con registros del d√≠a...');
                const todosResponse = await fetch(`${API_BASE}/registros/${sedeActual}/${fecha}`);
                const todosResult = await todosResponse.json();
                
                const registrosEmpleado = todosResult.data.filter(r => r.documento === empleadoValidado.documento);
                console.log('üîç Registros del empleado hoy:', registrosEmpleado);
                
                // 4. Determinar estado real
                let estadoTexto = 'üî¥ Sin Sesi√≥n';
                let puedeEntrar = true;
                let puedeSalir = false;
                let tieneRegistroActivoReal = false;
                
                // Verificar si realmente tiene sesi√≥n activa
                if (activoResult.data && activoResult.data.estado === 'activo') {
                    tieneRegistroActivoReal = true;
                    estadoTexto = 'üü¢ Sesi√≥n Activa';
                    puedeEntrar = false;
                    puedeSalir = true;
                    console.log('üü¢ Empleado tiene sesi√≥n activa confirmada');
                } else if (registrosEmpleado.length > 0) {
                    // Verificar si hay alg√∫n registro activo en la lista completa
                    const registroActivoEnLista = registrosEmpleado.find(r => r.estado === 'activo');
                    if (registroActivoEnLista) {
                        console.log('‚ö†Ô∏è Inconsistencia detectada: registro activo encontrado en lista pero no en consulta individual');
                        tieneRegistroActivoReal = true;
                        estadoTexto = 'üü¢ Sesi√≥n Activa (Detectada)';
                        puedeEntrar = false;
                        puedeSalir = true;
                    } else {
                        // Verificar √∫ltimo estado
                        const ultimoRegistro = registrosEmpleado[0]; // Ya ordenados por fecha descendente
                        if (ultimoRegistro.estado === 'finalizado') {
                            estadoTexto = '‚úÖ √öltima sesi√≥n finalizada';
                            puedeEntrar = true;
                            puedeSalir = false;
                            console.log('‚úÖ √öltima sesi√≥n finalizada');
                        } else if (ultimoRegistro.estado === 'forzado') {
                            estadoTexto = '‚ö†Ô∏è Sesi√≥n anterior forzada';
                            puedeEntrar = true;
                            puedeSalir = false;
                            console.log('‚ö†Ô∏è Sesi√≥n anterior forzada');
                        } else {
                            estadoTexto = 'üî¥ Sin Sesi√≥n';
                            puedeEntrar = true;
                            puedeSalir = false;
                            console.log('üî¥ Sin registros activos hoy');
                        }
                    }
                } else {
                    estadoTexto = 'üî¥ Sin Sesi√≥n';
                    puedeEntrar = true;
                    puedeSalir = false;
                    console.log('üî¥ Sin registros hoy');
                }
                
                // Actualizar estado local
                tieneRegistroActivo = tieneRegistroActivoReal;
                
                console.log('üìä Estado final determinado:', {
                    estadoTexto,
                    puedeEntrar,
                    puedeSalir,
                    tieneRegistroActivo,
                    registrosHoy: registrosEmpleado.length
                });

                // Actualizar interfaz
                document.getElementById('empleadoNombre').textContent = `${empleadoValidado.nombre} (${empleadoValidado.documento})`;
                document.getElementById('empleadoEstado').textContent = estadoTexto;
                
                // Mostrar/ocultar botones seg√∫n estado
                document.getElementById('btnEntrada').style.display = puedeEntrar ? 'inline-block' : 'none';
                document.getElementById('btnSalida').style.display = puedeSalir ? 'inline-block' : 'none';
                
                console.log('üéõÔ∏è Botones configurados:', {
                    entrada: puedeEntrar ? 'visible' : 'oculto',
                    salida: puedeSalir ? 'visible' : 'oculto'
                });
                
                // Mostrar secci√≥n de informaci√≥n
                document.getElementById('empleadoInfo').style.display = 'block';

                // Mostrar alerta de √©xito solo si es la primera validaci√≥n
                if (!document.getElementById('empleadoInfo').style.display || document.getElementById('empleadoInfo').style.display === 'none') {
                    mostrarAlerta(`‚úÖ Empleado validado: ${empleadoValidado.nombre}`, 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Error verificando estado completo:', error);
                mostrarError(`Error verificando estado: ${error.message}`);
            }
        }

        // Funci√≥n para refrescar el estado del empleado (simplificada)
        async function refrescarEstadoEmpleado() {
            console.log('üîÑ Refrescando estado del empleado...');
            await verificarEstadoCompletoEmpleado();
        }

        // Funci√≥n para limpiar formulario
        function limpiarFormulario() {
            console.log('üßπ Limpiando formulario...');
            document.getElementById('documento').value = '';
            document.getElementById('empleadoInfo').style.display = 'none';
            empleadoValidado = null;
            tieneRegistroActivo = false;
            document.getElementById('documento').focus();
            console.log('‚úÖ Formulario limpiado');
        }

        // Funci√≥n para limpiar formulario despu√©s de operaci√≥n exitosa
        function limpiarFormularioExitoso() {
            console.log('üßπ Limpiando formulario despu√©s de operaci√≥n exitosa...');
            setTimeout(() => {
                limpiarFormulario();
            }, 2000); // Esperar 2 segundos para que el usuario vea el mensaje de √©xito
        }

        // Funci√≥n para seleccionar sede
        function seleccionarSede(sedeId, nombre) {
            console.log('üè¢ Seleccionando sede:', nombre, 'ID:', sedeId);
            sedeActual = sedeId;
            sedeNombre = nombre;
            
            // Actualizar interfaz
            document.querySelectorAll('.sede-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-sede="${sedeId}"]`).classList.add('active');
            
            // Cargar datos de la sede
            cargarDatosSede();
        }

        function actualizarProgreso(mensaje) {
            const detailElement = document.getElementById('loadingDetail');
            if (detailElement) {
                detailElement.textContent = mensaje;
            }
        }

        async function cargarDatosSede() {
            if (!sedeActual) return;

            console.log('üìÇ Cargando datos de sede:', sedeNombre);
            
            document.getElementById('sedeSelector').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            try {
                actualizarProgreso('Conectando con la base de datos...');
                
                // Cargar registros del d√≠a
                actualizarProgreso('Cargando registros del d√≠a...');
                await cargarRegistrosHoy();
                
                // Cargar estad√≠sticas
                actualizarProgreso('Calculando estad√≠sticas...');
                await cargarEstadisticas();
                
                // Auto-sincronizar estado del empleado si est√° validado
                if (empleadoValidado) {
                    actualizarProgreso('Sincronizando estado del empleado...');
                    await verificarEstadoCompletoEmpleado();
                }
                
                actualizarProgreso('Inicializando sistema...');
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    
                    document.getElementById('sedeInfo').textContent = sedeNombre;
                    actualizarTablaRegistros();
                    actualizarEstadisticasUI();
                    
                    document.getElementById('documento').focus();
                    mostrarAlerta(`‚úÖ ${sedeNombre} conectado - Sistema listo`, 'success');
                }, 500);
                
            } catch (error) {
                console.error('Error cargando sede:', error);
                mostrarError(`Error conectando con ${sedeNombre}: ${error.message}`);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('sedeSelector').style.display = 'block';
            }
        }



        async function cargarRegistrosHoy() {
            const { fecha } = getColombiaDateTime();
            const response = await fetch(`${API_BASE}/registros/${sedeActual}/${fecha}`);
            const result = await response.json();
            
            if (result.success) {
                registros = result.data;
                console.log('Registros cargados:', registros.length);
            } else {
                throw new Error('Error cargando registros');
            }
        }

        async function cargarEstadisticas() {
            const { fecha } = getColombiaDateTime();
            const response = await fetch(`${API_BASE}/estadisticas/${sedeActual}/${fecha}`);
            const result = await response.json();
            
            if (result.success) {
                estadisticas = result.data;
                console.log('Estad√≠sticas cargadas:', estadisticas);
            } else {
                throw new Error('Error cargando estad√≠sticas');
            }
        }

        function actualizarEstadisticasUI() {
            document.getElementById('totalRegistros').textContent = estadisticas.total_registros || 0;
            document.getElementById('empleadosActivos').textContent = estadisticas.empleados_activos || 0;
                    document.getElementById('totalHoras').textContent = (parseFloat(estadisticas.horas_totales) || 0).toFixed(1);
        document.getElementById('promedioHoras').textContent = (parseFloat(estadisticas.promedio_horas) || 0).toFixed(1);

            document.getElementById('statsChips').innerHTML = `
                <span class="stat-chip">${estadisticas.total_registros || 0} registros</span>
                <span class="stat-chip">${estadisticas.empleados_activos || 0} activos</span>
            `;
        }

        async function registrarEntrada() {
            if (!empleadoValidado) {
                mostrarAlerta('‚ö†Ô∏è Por favor valida un usuario primero', 'warning');
                return;
            }

            if (procesandoEntrada) {
                console.log('‚è≥ Ya se est√° procesando una entrada...');
                return;
            }

            procesandoEntrada = true;
            console.log('üîç Iniciando registro de entrada para:', empleadoValidado.documento);

            try {
                const { fecha } = getColombiaDateTime();
                
                // Verificar nuevamente si tiene registro activo antes de crear uno nuevo
                console.log('üîç Verificando sesi√≥n activa...');
                const verificarActivoResponse = await fetch(`${API_BASE}/registros/activo/${empleadoValidado.documento}?fecha=${fecha}`);
                const verificarActivoResult = await verificarActivoResponse.json();
                
                console.log('üîç Resultado verificaci√≥n activa:', verificarActivoResult);
                
                if (verificarActivoResult.data && verificarActivoResult.data.estado === 'activo') {
                    console.log('‚ùå Sesi√≥n activa detectada, bloqueando nueva entrada');
                    mostrarAlerta('‚ö†Ô∏è Este usuario ya tiene una sesi√≥n activa. Debes cerrar la sesi√≥n actual antes de abrir una nueva.', 'warning');
                    // Actualizar el estado local
                    tieneRegistroActivo = true;
                    document.getElementById('empleadoEstado').textContent = 'üü¢ Sesi√≥n Activa';
                    document.getElementById('btnEntrada').style.display = 'none'; // BLOQUEAR entrada
                    document.getElementById('btnSalida').style.display = 'inline-block';
                    return;
                }

                console.log('‚úÖ No hay sesi√≥n activa, procediendo con entrada...');

                // Crear registro de entrada
                const { fecha: fechaEntrada, hora: horaEntrada } = getColombiaDateTime();

                console.log('üìù Creando registro con datos:', {
                    empleado_id: empleadoValidado.id,
                    sede_id: sedeActual,
                    fecha_entrada: fechaEntrada,
                    hora_entrada: horaEntrada
                });

                const registroResponse = await fetch(`${API_BASE}/registros/entrada`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        empleado_id: empleadoValidado.id,
                        sede_id: sedeActual,
                        fecha_entrada: fechaEntrada,
                        hora_entrada: horaEntrada
                    })
                });

                const registroResult = await registroResponse.json();
                console.log('üìù Resultado creaci√≥n registro:', registroResult);
                
                if (!registroResult.success) {
                    if (registroResult.message && registroResult.message.includes('sesi√≥n activa')) {
                        console.log('‚ùå Backend detect√≥ sesi√≥n activa');
                        mostrarAlerta('‚ö†Ô∏è El sistema detect√≥ una sesi√≥n activa. Refrescando estado...', 'warning');
                        // Refrescar estado y bloquear entrada
                        await refrescarEstadoEmpleado();
                        return;
                    }
                    throw new Error(registroResult.message || 'Error registrando entrada');
                }

                console.log('‚úÖ Registro creado exitosamente');

                // Recargar datos
                console.log('üîÑ Recargando datos...');
                await cargarRegistrosHoy();
                await cargarEstadisticas();
                actualizarTablaRegistros();
                actualizarEstadisticasUI();

                // Actualizar estado del empleado
                console.log('üîÑ Actualizando estado del usuario...');
                await refrescarEstadoEmpleado();

                mostrarAlerta(`‚úÖ Entrada registrada para ${empleadoValidado.nombre} (${empleadoValidado.documento})`, 'success');
                limpiarFormularioExitoso(); // Llamar a la nueva funci√≥n

            } catch (error) {
                console.error('‚ùå Error registrando entrada:', error);
                mostrarError(`Error: ${error.message}`);
            } finally {
                procesandoEntrada = false;
                console.log('‚úÖ Procesamiento de entrada finalizado');
            }
        }

        async function registrarSalida() {
            if (!empleadoValidado) {
                mostrarAlerta('‚ö†Ô∏è Por favor valida un usuario primero', 'warning');
                return;
            }

            if (procesandoSalida) {
                console.log('‚è≥ Ya se est√° procesando una salida...');
                return;
            }

            procesandoSalida = true;
            console.log('üîç Iniciando registro de salida para:', empleadoValidado.documento);

            try {
                const { fecha } = getColombiaDateTime();
                
                // Verificar nuevamente si tiene registro activo antes de finalizar
                console.log('üîç Verificando sesi√≥n activa...');
                const verificarActivoResponse = await fetch(`${API_BASE}/registros/activo/${empleadoValidado.documento}?fecha=${fecha}`);
                const verificarActivoResult = await verificarActivoResponse.json();
                
                console.log('üîç Resultado verificaci√≥n activa:', verificarActivoResult);
                
                if (!verificarActivoResult.data || verificarActivoResult.data.estado !== 'activo') {
                    console.log('‚ùå No hay sesi√≥n activa para cerrar');
                    mostrarAlerta('‚ö†Ô∏è Este empleado no tiene una sesi√≥n activa', 'warning');
                    // Actualizar el estado local
                    tieneRegistroActivo = false;
                    document.getElementById('empleadoEstado').textContent = 'üî¥ Sin Sesi√≥n';
                    document.getElementById('btnEntrada').style.display = 'inline-block';
                    document.getElementById('btnSalida').style.display = 'none';
                    return;
                }

                console.log('‚úÖ Sesi√≥n activa encontrada, procediendo con salida...');

                // Buscar registro activo
                const activoResponse = await fetch(`${API_BASE}/registros/activo/${empleadoValidado.documento}?fecha=${fecha}`);
                const activoResult = await activoResponse.json();
                
                if (!activoResult.data) {
                    console.log('‚ùå No se pudo obtener el registro activo');
                    mostrarAlerta('‚ö†Ô∏è Este usuario no tiene una sesi√≥n activa', 'warning');
                    return;
                }

                const registro = activoResult.data;
                const { fecha: fechaSalida, hora: horaSalida } = getColombiaDateTime();

                console.log('üìù Finalizando registro con datos:', {
                    registro_id: registro.id,
                    fecha_salida: fechaSalida,
                    hora_salida: horaSalida
                });

                // Finalizar registro
                const finalizarResponse = await fetch(`${API_BASE}/registros/${registro.id}/salida`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fecha_salida: fechaSalida,
                        hora_salida: horaSalida
                    })
                });

                const finalizarResult = await finalizarResponse.json();
                console.log('üìù Resultado finalizaci√≥n:', finalizarResult);
                
                if (!finalizarResult.success) {
                    throw new Error(finalizarResult.message || 'Error registrando salida');
                }

                console.log('‚úÖ Salida registrada exitosamente');

                // Recargar datos
                console.log('üîÑ Recargando datos...');
                await cargarRegistrosHoy();
                await cargarEstadisticas();
                actualizarTablaRegistros();
                actualizarEstadisticasUI();

                // Actualizar estado del empleado
                console.log('üîÑ Actualizando estado del empleado...');
                await refrescarEstadoEmpleado();

                const duracionHoras = finalizarResult.data.duracion_horas || 0;
                const duracion = duracionHoras >= 7.5 ? '‚úÖ Completado' : 
                                duracionHoras > 0 ? `${duracionHoras.toFixed(2)}h` : '-';
                mostrarAlerta(`‚úÖ Salida registrada para ${empleadoValidado.nombre} - Duraci√≥n: ${duracion}`, 'success');
                limpiarFormularioExitoso(); // Llamar a la nueva funci√≥n

            } catch (error) {
                console.error('‚ùå Error registrando salida:', error);
                mostrarError(`Error: ${error.message}`);
            } finally {
                procesandoSalida = false;
                console.log('‚úÖ Procesamiento de salida finalizado');
            }
        }

        function actualizarTablaRegistros() {
            const container = document.getElementById('registrosContainer');
            
            if (registros.length === 0) {
                container.innerHTML = `
                    <div class="no-records">
                        <h3>üìù Sin registros</h3>
                        <p>Registra la entrada de un usuario para comenzar</p>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Documento</th>
                            <th>Nombre</th>
                            <th>Entrada</th>
                            <th>Hora Entrada</th>
                            <th>Salida</th>
                            <th>Hora Salida</th>
                            <th>Estado</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            registros.forEach((registro, index) => {
                const rowClass = registro.estado === 'activo' ? 'status-active' : 
                               registro.estado === 'forzado' ? 'status-forzado' : 'status-finalizado';
                
                                 const estado = registro.estado === 'activo' ? 'üü¢ Activo' : 
                              registro.estado === 'forzado' ? '‚ö†Ô∏è Forzado' : '‚úÖ Finalizado';
                
                const duracionHoras = parseFloat(registro.duracion_horas) || 0;
                const duracion = duracionHoras >= 7.5 ? '‚úÖ Completado' : 
                                duracionHoras > 0 ? `${duracionHoras.toFixed(2)}h` : '-';
                const fechaEntrada = new Date(registro.hora_entrada).toLocaleDateString('es-CO', {timeZone: "America/Bogota"});
                const horaEntrada = new Date(registro.hora_entrada).toLocaleTimeString('es-CO', {timeZone: "America/Bogota"});
                const fechaSalida = registro.fecha_salida ? new Date(registro.fecha_salida).toLocaleDateString('es-CO', {timeZone: "America/Bogota"}) : '-';
                const horaSalida = registro.hora_salida ? new Date(registro.hora_salida).toLocaleTimeString('es-CO', {timeZone: "America/Bogota"}) : '-';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${index + 1}</td>
                        <td><span class="time-badge">${registro.documento}</span></td>
                        <td>${registro.nombre_empleado}</td>
                        <td>${fechaEntrada}</td>
                        <td>${horaEntrada}</td>
                        <td>${fechaSalida}</td>
                        <td>${horaSalida}</td>
                        <td>${estado}</td>
                        <td>
                            ${registro.estado === 'activo' ? 
                                `<button class="btn btn-warning" style="font-size: 10px; padding: 2px 6px;" onclick="forzarSalida(${registro.id})">üö™</button>` : 
                                `<button class="btn btn-danger" style="font-size: 10px; padding: 2px 6px;" onclick="eliminarRegistro(${registro.id})">‚ùå</button>`
                            }
                        </td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        async function forzarSalida(registroId) {
            const registro = registros.find(r => r.id === registroId);
            if (!registro) return;

            if (confirm(`¬øForzar salida para ${registro.nombre_empleado}?`)) {
                try {
                    const { fecha: fechaSalida, hora: horaSalida } = getColombiaDateTime();

                    const response = await fetch(`${API_BASE}/registros/${registroId}/forzar`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fecha_salida: fechaSalida,
                            hora_salida: horaSalida
                        })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.message || 'Error forzando salida');
                    }

                    // Recargar datos
                    await cargarRegistrosHoy();
                    await cargarEstadisticas();
                    actualizarTablaRegistros();
                    actualizarEstadisticasUI();

                    mostrarAlerta(`‚úÖ Salida forzada para ${registro.nombre_empleado}`, 'success');
                } catch (error) {
                    console.error('Error forzando salida:', error);
                    mostrarError(`Error: ${error.message}`);
                }
            }
        }

        async function eliminarRegistro(registroId) {
            const registro = registros.find(r => r.id === registroId);
            if (!registro) return;

            if (confirm(`¬øEliminar registro de ${registro.nombre_empleado}?`)) {
                // Nota: En una implementaci√≥n real, aqu√≠ se har√≠a una llamada DELETE a la API
                // Por ahora solo mostramos un mensaje
                mostrarAlerta('‚ö†Ô∏è Funci√≥n de eliminaci√≥n no implementada en esta versi√≥n', 'warning');
            }
        }

        async function finalizarJornada() {
            if (estadisticas.empleados_activos === 0) {
                mostrarAlerta('‚ö†Ô∏è No hay usuarios activos', 'warning');
                return;
            }

            // Solicitar password para finalizar jornada
            const password = prompt('üîê Ingresa la contrase√±a para finalizar jornada:');
            if (password !== 'admin123') {
                mostrarAlerta('‚ùå Contrase√±a incorrecta', 'error');
                return;
            }

            if (confirm(`¬øFinalizar jornada para ${estadisticas.empleados_activos} empleado(s) activo(s)?`)) {
                try {
                    const { fecha: fechaSalida, hora: horaSalida } = getColombiaDateTime();

                    const response = await fetch(`${API_BASE}/registros/finalizar-jornada`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            sede_id: sedeActual,
                            fecha_salida: fechaSalida,
                            hora_salida: horaSalida
                        })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.message || 'Error finalizando jornada');
                    }

                    // Recargar datos
                    await cargarRegistrosHoy();
                    await cargarEstadisticas();
                    actualizarTablaRegistros();
                    actualizarEstadisticasUI();

                    mostrarAlerta(`‚úÖ Jornada finalizada para ${result.data.registros_actualizados} empleado(s)`, 'success');
                } catch (error) {
                    console.error('Error finalizando jornada:', error);
                    mostrarError(`Error: ${error.message}`);
                }
            }
        }

        function cambiarSede() {
            if (confirm('¬øEst√°s seguro de que quieres cambiar de sede?')) {
                sedeActual = null;
                sedeNombre = '';
                registros = [];
                estadisticas = {
                    total_registros: 0,
                    empleados_activos: 0,
                    horas_totales: 0,
                    promedio_horas: 0
                };
                
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('sedeSelector').style.display = 'block';
                
                document.querySelectorAll('.sede-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.getElementById('sedeInfo').textContent = '-';
                
                mostrarAlerta('üîÑ Selecciona una nueva sede', 'success');
            }
        }

        function exportarRegistros() {
            if (registros.length === 0) {
                mostrarAlerta('‚ö†Ô∏è No hay registros para exportar', 'warning');
                return;
            }

            // Solicitar password para acceder al historial
            const password = prompt('üîê Ingresa la contrase√±a para exportar registros:');
            if (password !== 'admin123') {
                mostrarAlerta('‚ùå Contrase√±a incorrecta', 'error');
                return;
            }

            // Agrupar registros por empleado y sumar horas totales
            const empleadosHoras = {};
            registros.forEach(registro => {
                const key = `${registro.documento}_${registro.nombre_empleado}`;
                if (!empleadosHoras[key]) {
                    empleadosHoras[key] = {
                        documento: registro.documento,
                        nombre: registro.nombre_empleado,
                        horasTotales: 0,
                        sesiones: 0
                    };
                }
                
                if (registro.estado !== 'activo' && registro.duracion_horas) {
                    empleadosHoras[key].horasTotales += parseFloat(registro.duracion_horas) || 0;
                    empleadosHoras[key].sesiones++;
                }
            });

            // Crear contenido para impresora POS 80mm
            let contenidoPOS = '';
            contenidoPOS += '================================================\n';
            contenidoPOS += '    CONTROL DE HORAS - RESUMEN DIARIO          \n';
            contenidoPOS += '================================================\n';
            contenidoPOS += `Sede: ${sedeNombre}\n`;
            const { fecha: fechaExport, horaLocal } = getColombiaDateTime();
            contenidoPOS += `Fecha: ${fechaExport}\n`;
            contenidoPOS += `Hora: ${horaLocal}\n`;
            contenidoPOS += `Total colaboradores: ${Object.keys(empleadosHoras).length}\n`;
            contenidoPOS += `Usuarios activos: ${estadisticas.empleados_activos}\n`;
            contenidoPOS += '================================================\n';
            
            // Mostrar resumen por empleado
            Object.values(empleadosHoras).forEach((empleado, index) => {
                contenidoPOS += `${(index + 1).toString().padStart(2)}. ${empleado.documento}\n`;
                contenidoPOS += `    ${empleado.nombre}\n`;
                contenidoPOS += `    Sesiones: ${empleado.sesiones}\n`;
                const horasFormateadas = empleado.horasTotales >= 7.5 ? '‚úÖ Completado' : 
                                        empleado.horasTotales > 0 ? `${empleado.horasTotales.toFixed(2)}h` : '0h';
                contenidoPOS += `    Horas totales: ${horasFormateadas}\n`;
                contenidoPOS += '    ----------------------------------------\n';
            });
            
            contenidoPOS += '================================================\n';
            contenidoPOS += `RESUMEN: Colaboradores: ${Object.keys(empleadosHoras).length} | Activos: ${estadisticas.empleados_activos}\n`;
            contenidoPOS += `Horas totales: ${(parseFloat(estadisticas.horas_totales) || 0).toFixed(1)}h\n`;
            contenidoPOS += '================================================\n';

            // Crear archivo de texto
            const blob = new Blob([contenidoPOS], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const { fecha: fechaArchivo } = getColombiaDateTime();
            a.download = `control_horas_${sedeNombre.toLowerCase()}_${fechaArchivo}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            mostrarAlerta('‚úÖ Registros exportados como archivo de texto', 'success');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                const documento = document.getElementById('documento').value.trim();
                
                if (documento) {
                    validarEmpleado();
                } else {
                    document.getElementById('documento').focus();
                }
            }
        }

        function mostrarAlerta(mensaje, tipo) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo}`;
            alertDiv.innerHTML = mensaje;
            
            const content = document.querySelector('.content');
            const firstChild = content.firstElementChild;
            content.insertBefore(alertDiv, firstChild.nextSibling);
            
            // Auto-remover despu√©s de 4 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 4000);
        }

        async function verHistorialEmpleado() {
            if (!empleadoValidado) {
                mostrarAlerta('‚ö†Ô∏è Por favor valida un usuario primero', 'warning');
                return;
            }

            // Solicitar password para acceder al historial
            const password = prompt('üîê Ingresa la contrase√±a para ver el historial:');
            if (password !== 'admin123') {
                mostrarAlerta('‚ùå Contrase√±a incorrecta', 'error');
                return;
            }

            try {
                const { fecha } = getColombiaDateTime();
                const response = await fetch(`${API_BASE}/registros/${sedeActual}/${fecha}`);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error('Error cargando historial');
                }

                // Filtrar registros del empleado actual
                const registrosEmpleado = result.data.filter(r => r.documento === empleadoValidado.documento);
                
                if (registrosEmpleado.length === 0) {
                    mostrarAlerta('üìù No hay registros para este usuario hoy', 'info');
                    return;
                }

                // Crear modal para mostrar historial
                const modalHTML = `
                    <div id="historialModal" class="modal-overlay">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>üìã Historial de ${empleadoValidado.nombre}</h3>
                                <button class="modal-close" onclick="cerrarModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="historial-info">
                                    <p><strong>Documento:</strong> ${empleadoValidado.documento}</p>
                                    <p><strong>Fecha:</strong> ${fecha}</p>
                                    <p><strong>Total sesiones:</strong> ${registrosEmpleado.length}</p>
                                </div>
                                <div class="historial-sesiones">
                                    ${registrosEmpleado.map((registro, index) => {
                                        const entrada = new Date(registro.hora_entrada).toLocaleTimeString('es-CO', {timeZone: "America/Bogota"});
                                        const salida = registro.hora_salida ? new Date(registro.hora_salida).toLocaleTimeString('es-CO', {timeZone: "America/Bogota"}) : 'En curso';
                                        const duracionHoras = parseFloat(registro.duracion_horas) || 0;
                                        const duracion = duracionHoras >= 7.5 ? '‚úÖ Completado' : 
                                                        duracionHoras > 0 ? `${duracionHoras.toFixed(2)}h` : '-';
                                        const estado = registro.estado === 'activo' ? 'üü¢ Activo' : 
                                                     registro.estado === 'forzado' ? '‚ö†Ô∏è Forzado' : '‚úÖ Finalizado';
                                        
                                        return `
                                            <div class="sesion-item ${registro.estado === 'activo' ? 'sesion-activa' : ''}">
                                                <div class="sesion-header">
                                                    <span class="sesion-numero">Sesi√≥n ${index + 1}</span>
                                                    <span class="sesion-estado">${estado}</span>
                                                </div>
                                                <div class="sesion-details">
                                                    <div class="sesion-time">
                                                        <span class="time-label">Entrada:</span>
                                                        <span class="time-value">${entrada}</span>
                                                    </div>
                                                    <div class="sesion-time">
                                                        <span class="time-label">Salida:</span>
                                                        <span class="time-value">${salida}</span>
                                                    </div>
                                                    <div class="sesion-time">
                                                        <span class="time-label">Duraci√≥n:</span>
                                                        <span class="time-value">${duracion}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="cerrarModal()">Cerrar</button>
                            </div>
                        </div>
                    </div>
                `;

                // Agregar modal al DOM
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
            } catch (error) {
                console.error('Error mostrando historial:', error);
                mostrarError(`Error: ${error.message}`);
            }
        }

        function cerrarModal() {
            const modal = document.getElementById('historialModal');
            if (modal) {
                modal.remove();
            }
        }

        function mostrarError(mensaje) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `<strong>Error:</strong> ${mensaje}`;
            document.querySelector('.content').appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 8000);
        }

        // Nuevas funcionalidades adicionales

        // Funci√≥n para exportar registros de una fecha espec√≠fica
        async function exportarFechaEspecifica() {
            if (!sedeActual) {
                mostrarAlerta('‚ö†Ô∏è Primero selecciona una sede', 'warning');
                return;
            }

            // Solicitar password para acceder a la exportaci√≥n
            const password = prompt('üîê Ingresa la contrase√±a para exportar registros:');
            if (password !== 'admin123') {
                mostrarAlerta('‚ùå Contrase√±a incorrecta', 'error');
                return;
            }

            // Solicitar fecha espec√≠fica
            const { fecha } = getColombiaDateTime();
            const fechaEspecifica = prompt('üìÖ Ingresa la fecha (YYYY-MM-DD):', fecha);
            if (!fechaEspecifica) {
                mostrarAlerta('‚ö†Ô∏è Debes ingresar una fecha v√°lida', 'warning');
                return;
            }

            // Validar formato de fecha
            const fechaRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (!fechaRegex.test(fechaEspecifica)) {
                mostrarAlerta('‚ùå Formato de fecha inv√°lido. Usa YYYY-MM-DD', 'error');
                return;
            }

            try {
                console.log('üìÖ Exportando registros para fecha:', fechaEspecifica);

                // Obtener registros de la fecha espec√≠fica
                const registrosResponse = await fetch(`${API_BASE}/registros/fecha/${sedeActual}/${fechaEspecifica}`);
                const registrosResult = await registrosResponse.json();

                if (!registrosResult.success) {
                    throw new Error('Error obteniendo registros de la fecha espec√≠fica');
                }

                const registrosFecha = registrosResult.data;

                if (registrosFecha.length === 0) {
                    mostrarAlerta('üìù No hay registros para la fecha seleccionada', 'info');
                    return;
                }

                // Obtener estad√≠sticas de la fecha espec√≠fica
                const estadisticasResponse = await fetch(`${API_BASE}/registros/estadisticas/${sedeActual}/${fechaEspecifica}`);
                const estadisticasResult = await estadisticasResponse.json();

                if (!estadisticasResult.success) {
                    throw new Error('Error obteniendo estad√≠sticas de la fecha espec√≠fica');
                }

                const estadisticasFecha = estadisticasResult.data;

                // Agrupar registros por empleado y sumar horas totales
                const empleadosHoras = {};
                registrosFecha.forEach(registro => {
                    const key = `${registro.documento}_${registro.nombre_empleado}`;
                    if (!empleadosHoras[key]) {
                        empleadosHoras[key] = {
                            documento: registro.documento,
                            nombre: registro.nombre_empleado,
                            horasTotales: 0,
                            sesiones: 0
                        };
                    }
                    
                    if (registro.estado !== 'activo' && registro.duracion_horas) {
                        empleadosHoras[key].horasTotales += parseFloat(registro.duracion_horas) || 0;
                        empleadosHoras[key].sesiones++;
                    }
                });

                // Crear contenido para impresora POS 80mm
                let contenidoPOS = '';
                contenidoPOS += '================================================\n';
                contenidoPOS += '    CONTROL DE HORAS - RESUMEN POR FECHA        \n';
                contenidoPOS += '================================================\n';
                contenidoPOS += `Sede: ${sedeNombre}\n`;
                contenidoPOS += `Fecha: ${fechaEspecifica}\n`;
                contenidoPOS += `Hora: ${getColombiaDateTime().horaLocal}\n`;
                contenidoPOS += `Total colaboradores: ${Object.keys(empleadosHoras).length}\n`;
                contenidoPOS += `Usuarios activos: ${estadisticasFecha.empleados_activos || 0}\n`;
                contenidoPOS += '================================================\n';
                
                // Mostrar resumen por empleado
                Object.values(empleadosHoras).forEach((empleado, index) => {
                    contenidoPOS += `${(index + 1).toString().padStart(2)}. ${empleado.documento}\n`;
                    contenidoPOS += `    ${empleado.nombre}\n`;
                    contenidoPOS += `    Sesiones: ${empleado.sesiones}\n`;
                    const horasFormateadas = empleado.horasTotales >= 7.5 ? '‚úÖ Completado' : 
                                            empleado.horasTotales > 0 ? `${empleado.horasTotales.toFixed(2)}h` : '0h';
                    contenidoPOS += `    Horas totales: ${horasFormateadas}\n`;
                    contenidoPOS += '    ----------------------------------------\n';
                });
                
                contenidoPOS += '================================================\n';
                contenidoPOS += `RESUMEN: Colaboradores: ${Object.keys(empleadosHoras).length} | Activos: ${estadisticasFecha.empleados_activos || 0}\n`;
                contenidoPOS += `Horas totales: ${(parseFloat(estadisticasFecha.horas_totales) || 0).toFixed(1)}h\n`;
                contenidoPOS += '================================================\n';

                // Crear archivo de texto
                const blob = new Blob([contenidoPOS], { type: 'text/plain;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `control_horas_${sedeNombre.toLowerCase()}_${fechaEspecifica}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                mostrarAlerta(`‚úÖ Registros exportados para ${fechaEspecifica}`, 'success');

            } catch (error) {
                console.error('Error exportando registros de fecha espec√≠fica:', error);
                mostrarError(`Error: ${error.message}`);
            }
        }

        // Funci√≥n para cerrar sesiones autom√°ticamente a las 10pm
        async function cerrarSesionesAutomaticas() {
            if (!sedeActual) {
                mostrarAlerta('‚ö†Ô∏è Primero selecciona una sede', 'warning');
                return;
            }

            // Solicitar password para acceder a la funci√≥n
            const password = prompt('üîê Ingresa la contrase√±a para cerrar sesiones autom√°ticas:');
            if (password !== 'admin123') {
                mostrarAlerta('‚ùå Contrase√±a incorrecta', 'error');
                return;
            }

            // Confirmar acci√≥n
            const confirmacion = confirm('üïô ¬øEst√°s seguro de que quieres cerrar todas las sesiones activas autom√°ticamente?');
            if (!confirmacion) {
                return;
            }

            try {
                console.log('üïô Cerrando sesiones autom√°ticas para sede:', sedeActual);

                const response = await fetch(`${API_BASE}/registros/cerrar-sesiones-automaticas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sede_id: sedeActual
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error('Error cerrando sesiones autom√°ticas');
                }

                const { registros_cerrados, fecha, hora } = result.data;

                if (registros_cerrados > 0) {
                    mostrarAlerta(`‚úÖ ${registros_cerrados} sesiones cerradas autom√°ticamente a las ${hora}`, 'success');
                    
                    // Recargar registros para mostrar el estado actualizado
                    await cargarRegistros();
                } else {
                    mostrarAlerta('üìù No hay sesiones activas para cerrar', 'info');
                }

            } catch (error) {
                console.error('Error cerrando sesiones autom√°ticas:', error);
                mostrarError(`Error: ${error.message}`);
            }
        }

        // Funci√≥n para verificar y cerrar sesiones autom√°ticamente a las 10pm
        function verificarCierreAutomatico() {
            const { horaLocal } = getColombiaDateTime();
            const [hora, minutos] = horaLocal.split(':').map(Number);
            
            // Verificar si es exactamente las 10:00 PM (22:00)
            if (hora === 22 && minutos === 0) {
                console.log('üïô Ejecutando cierre autom√°tico de sesiones a las 10:00 PM');
                cerrarSesionesAutomaticas();
            }
        }

        // Configurar verificaci√≥n autom√°tica cada minuto
        setInterval(verificarCierreAutomatico, 60000); // Verificar cada minuto

        // Funci√≥n para mostrar sesiones activas
        async function mostrarSesionesActivas() {
            if (!sedeActual) {
                mostrarAlerta('‚ö†Ô∏è Primero selecciona una sede', 'warning');
                return;
            }

            try {
                console.log('üë• Obteniendo sesiones activas para sede:', sedeActual);

                const response = await fetch(`${API_BASE}/registros/sesiones-activas/${sedeActual}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error('Error obteniendo sesiones activas');
                }

                const sesionesActivas = result.data;

                if (sesionesActivas.length === 0) {
                    mostrarAlerta('üìù No hay sesiones activas en este momento', 'info');
                    return;
                }

                // Crear modal para mostrar sesiones activas
                const modalHTML = `
                    <div id="sesionesActivasModal" class="modal-overlay">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>üë• Sesiones Activas - ${sedeNombre}</h3>
                                <button class="modal-close" onclick="cerrarModalSesiones()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="sesiones-info">
                                    <p><strong>Total sesiones activas:</strong> ${sesionesActivas.length}</p>
                                    <p><strong>Fecha:</strong> ${getColombiaDateTime().fecha}</p>
                                </div>
                                <div class="sesiones-lista">
                                    ${sesionesActivas.map((sesion, index) => {
                                        const entrada = new Date(sesion.hora_entrada).toLocaleTimeString('es-CO', {timeZone: "America/Bogota"});
                                        const duracion = calcularDuracion(sesion.hora_entrada, new Date(getColombiaDateTime().hora));
                                        
                                        return `
                                            <div class="sesion-activa-item">
                                                <div class="sesion-activa-header">
                                                    <span class="sesion-activa-numero">${index + 1}</span>
                                                    <span class="sesion-activa-estado">üü¢ Activa</span>
                                                </div>
                                                <div class="sesion-activa-details">
                                                    <div class="sesion-activa-info">
                                                        <span class="info-label">Empleado:</span>
                                                        <span class="info-value">${sesion.nombre_empleado}</span>
                                                    </div>
                                                    <div class="sesion-activa-info">
                                                        <span class="info-label">Documento:</span>
                                                        <span class="info-value">${sesion.documento}</span>
                                                    </div>
                                                    <div class="sesion-activa-info">
                                                        <span class="info-label">Entrada:</span>
                                                        <span class="info-value">${entrada}</span>
                                                    </div>
                                                    <div class="sesion-activa-info">
                                                        <span class="info-label">Duraci√≥n:</span>
                                                        <span class="info-value">${duracion}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-warning" onclick="cerrarSesionesAutomaticas()">üïô Cerrar Todas</button>
                                <button class="btn btn-secondary" onclick="cerrarModalSesiones()">Cerrar</button>
                            </div>
                        </div>
                    </div>
                `;

                // Agregar modal al DOM
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
            } catch (error) {
                console.error('Error mostrando sesiones activas:', error);
                mostrarError(`Error: ${error.message}`);
            }
        }

        function cerrarModalSesiones() {
            const modal = document.getElementById('sesionesActivasModal');
            if (modal) {
                modal.remove();
            }
        }

        // Funci√≥n auxiliar para calcular duraci√≥n
        function calcularDuracion(horaEntrada, horaActual) {
            const entrada = new Date(horaEntrada);
            const diferencia = horaActual - entrada;
            const horas = Math.floor(diferencia / (1000 * 60 * 60));
            const minutos = Math.floor((diferencia % (1000 * 60 * 60)) / (1000 * 60));
            return `${horas}h ${minutos}m`;
        }


    </script>
</body>
</html>
