<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√≥digos Disponibles - APIs JSON v1.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f0f;
            font-size: 14px;
            line-height: 1.4;
            color: #ffffff;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #1a1a1a;
            min-height: 100vh;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 12px 20px;
            border-bottom: 3px solid #3498db;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .back-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .logo {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
        }

        .header-text {
            flex: 1;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header p {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .api-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .content {
            padding: 15px;
        }

        .start-section {
            background: #2a2a2a;
            border: 2px dashed #333;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .start-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 14px;
            color: #a0a0a0;
        }

        .loading-info {
            max-width: 600px;
            margin: 0 auto;
            background: #2a2a2a;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #444;
            margin-top: 20px;
        }

        .loading-info h3 {
            color: #3498db;
            margin: 0 0 15px 0;
            font-size: 18px;
        }

        .loading-info p {
            color: #e0e0e0;
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.4;
        }

        .loading-info strong {
            color: #ffffff;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-left: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            display: none;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #333;
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #a0a0a0;
            font-size: 11px;
        }

        .tables-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .table-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #333;
        }

        .table-title {
            font-size: 14px;
            margin-bottom: 15px;
            text-align: center;
            color: #ffffff;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
            font-weight: 600;
        }

        .safezone-info {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .safezone-title {
            color: #22c55e;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .safezone-text {
            color: #a0a0a0;
            font-size: 11px;
            line-height: 1.3;
        }

        .codes-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
        }

        .codes-table th {
            background: rgba(102, 126, 234, 0.2);
            color: #ffffff;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
            font-size: 11px;
        }

        .codes-table td {
            padding: 6px 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 11px;
        }

        .codes-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .code-item {
            font-family: 'Courier New', monospace;
            background: #1e3a2e;
            color: #4ade80;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }

        .actions {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .action-btn {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 0 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            font-weight: 600;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .action-btn.secondary {
            background: linear-gradient(45deg, #6b7280, #4b5563);
        }

        .action-btn.secondary:hover {
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            display: none;
            max-width: 300px;
        }

        .alert.success {
            background: #10b981;
            color: white;
        }

        .alert.error {
            background: #ef4444;
            color: white;
        }

        .api-status {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .api-status h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .api-status p {
            color: #a0a0a0;
            font-size: 12px;
            margin: 5px 0;
        }

        .last-update-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 6px;
        }

        .last-update-info p {
            margin: 5px 0;
            font-size: 11px;
            color: #e0e0e0;
        }

        .last-update-info strong {
            color: #667eea;
        }

        @media (max-width: 768px) {
            .tables-container {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">‚Üê Volver</a>
            <div class="logo">üè¢</div>
            <div class="header-text">
                <h1>C√≥digos Disponibles <span class="api-badge">APIs JSON</span></h1>
                <p>Sistema de gesti√≥n de c√≥digos libres con zonas seguras para Manizales y Dorada</p>
            </div>
        </div>

        <div class="content">
            <!-- Estado de APIs -->
            <div class="api-status" id="apiStatus">
                <h3>üîÑ Verificando conectividad de APIs...</h3>
                <p>Conectando con bases de datos en tiempo real</p>
                <div class="last-update-info" id="lastUpdateInfo">
                    <p><strong>üìÖ √öltima actualizaci√≥n:</strong> <span id="lastUpdateDate">Calculando...</span></p>
                    <p><strong>‚è∞ Pr√≥xima actualizaci√≥n:</strong> <span id="nextUpdateDate">Calculando...</span></p>
                </div>
            </div>

            <div class="start-section" id="start-section">
                <h2>üöÄ An√°lisis de C√≥digos Disponibles</h2>
                <p style="margin: 20px 0; color: #a0a0a0;">
                    Este sistema analiza las bases de datos de Manizales y Dorada para encontrar c√≥digos internos disponibles.
                    <br><br>
                    <strong>Proceso implementado:</strong><br>
                    1. Tomar todos los c√≥digos internos de ambas sedes y ponerlos en una lista<br>
                    2. Organizarla de mayor a menor<br>
                    3. Encontrar a partir de 5,000 los espacios vac√≠os (√∫nicos y sin usar)<br>
                    4. Presentar los primeros 100 libres para Dorada y los 100 siguientes para Manizales
                </p>
                <button class="start-btn" onclick="iniciarAnalisis()">
                    üöÄ Iniciar An√°lisis
                </button>
            </div>

            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Conectando con bases de datos...</p>
                
                <div class="loading-info">
                    <h3>üìä Procesamiento en Curso</h3>
                    <p><strong>Paso 1:</strong> Conectando con APIs JSON de Manizales y Dorada</p>
                    <p><strong>Paso 2:</strong> Tomando todos los c√≥digos internos de ambas sedes</p>
                    <p><strong>Paso 3:</strong> Organizando c√≥digos de mayor a menor</p>
                    <p><strong>Paso 4:</strong> Encontrando espacios vac√≠os desde c√≥digo 5000</p>
                    <p><strong>Paso 5:</strong> Distribuyendo c√≥digos por sede (100 para cada una)</p>
                </div>
            </div>

            <div class="results-section" id="results-section">
                <!-- Informaci√≥n de √∫ltima actualizaci√≥n en resultados -->
                <div class="last-update-info" style="margin-bottom: 20px;">
                    <p><strong>üìÖ √öltima actualizaci√≥n de datos:</strong> <span id="lastUpdateDateResults">Calculando...</span></p>
                    <p><strong>‚è∞ Pr√≥xima actualizaci√≥n:</strong> <span id="nextUpdateDateResults">Calculando...</span></p>
                </div>

                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-number" id="total-manizales">0</div>
                        <div class="stat-label">Productos Manizales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-dorada">0</div>
                        <div class="stat-label">Productos Dorada</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="safezone-manizales">0</div>
                        <div class="stat-label">Safezone Manizales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="safezone-dorada">0</div>
                        <div class="stat-label">Safezone Dorada</div>
                    </div>
                </div>

                <div class="tables-container">
                    <div class="table-section">
                        <div class="safezone-info">
                            <div class="safezone-title">üè™ Zona Segura Manizales</div>
                            <div class="safezone-text">
                                C√≥digos reservados para uso exclusivo de Manizales. 
                                Muestra c√≥digos 101-200 de los espacios libres encontrados desde 5000.
                                Proceso: c√≥digos ordenados de mayor a menor, espacios √∫nicos y sin usar.
                            </div>
                        </div>
                        <div class="table-title">üìä C√≥digos Disponibles - Manizales</div>
                        <div id="manizales-table-container"></div>
                    </div>

                    <div class="table-section">
                        <div class="safezone-info">
                            <div class="safezone-title">üè≠ Zona Segura Dorada</div>
                            <div class="safezone-text">
                                C√≥digos reservados para uso exclusivo de Dorada. 
                                Muestra c√≥digos 1-100 de los espacios libres encontrados desde 5000.
                                Proceso: c√≥digos ordenados de mayor a menor, espacios √∫nicos y sin usar.
                            </div>
                        </div>
                        <div class="table-title">üìä C√≥digos Disponibles - Dorada</div>
                        <div id="dorada-table-container"></div>
                    </div>
                </div>

                <div class="actions">
                    <button class="action-btn" onclick="exportarCodigosManizales()">
                        üì• Exportar Manizales
                    </button>
                    <button class="action-btn" onclick="exportarCodigosDorada()">
                        üì• Exportar Dorada
                    </button>
                    <button class="action-btn secondary" onclick="reiniciarAnalisis()">
                        üîÑ Reiniciar
                    </button>
                </div>
            </div>

            <div id="alert" class="alert"></div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de APIs
        const sedesConfig = {
            manizales: {
                nombre: 'Manizales',
                apiSede: 'manizales',
                apiUrl: 'https://cristaleria.average.lat/api/products-json',
                healthUrl: 'https://cristaleria.average.lat/api/health-db',
                icon: 'üè™',
                color: '#28a745'
            },
            dorada: {
                nombre: 'Dorada',
                apiSede: 'ladorada',
                apiUrl: 'https://cristaleria.average.lat/api/products-json',
                healthUrl: 'https://cristaleria.average.lat/api/health-db',
                icon: 'üè¨',
                color: '#3498db'
            }
        };

        let datosManizales = [];
        let datosDorada = [];
        let codigosDisponiblesManizales = [];
        let codigosDisponiblesDorada = [];
        let safezoneManizales = [];
        let safezoneDorada = [];

        // Verificar salud de las APIs
        async function verificarSaludAPIs() {
            try {
                const response = await fetch('https://cristaleria.average.lat/api/health-db', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    timeout: 60000
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                if (data.status !== 'healthy') {
                    throw new Error(`API no saludable: ${data.message || 'Estado desconocido'}`);
                }

                console.log('‚úÖ APIs saludables');
                return true;
            } catch (error) {
                console.error('‚ùå Error verificando salud de APIs:', error);
                throw new Error(`Error conectando con APIs: ${error.message}`);
            }
        }

        // Obtener datos con retry
        async function obtenerDatosConRetry(sede, maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`üîÑ Intento ${attempt}/${maxRetries} para ${sede}`);
                    
                    const response = await fetch(`https://cristaleria.average.lat/api/products-json?sede=${sede}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(`Error en API: ${data.message || 'Respuesta no exitosa'}`);
                    }

                    console.log(`‚úÖ Datos obtenidos de ${sede}:`, data.count, 'productos');
                    return data.data;
                } catch (error) {
                    console.error(`‚ùå Intento ${attempt} fall√≥ para ${sede}:`, error);
                    
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    // Espera exponencial antes del siguiente intento
                    const waitTime = Math.pow(2, attempt) * 1000;
                    console.log(`‚è≥ Esperando ${waitTime}ms antes del siguiente intento...`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
        }

        // Funci√≥n para obtener la fecha de la √∫ltima actualizaci√≥n (2am horario Americas)
        function obtenerUltimaActualizacion() {
            const ahora = new Date();
            const horaActual = ahora.getHours();
            const minutosActual = ahora.getMinutes();
            
            // Crear fecha de hoy a las 2am
            const hoy2am = new Date(ahora);
            hoy2am.setHours(2, 0, 0, 0);
            
            // Crear fecha de ayer a las 2am
            const ayer2am = new Date(ahora);
            ayer2am.setDate(ayer2am.getDate() - 1);
            ayer2am.setHours(2, 0, 0, 0);
            
            // Si ya pas√≥ las 2am de hoy, la √∫ltima actualizaci√≥n fue hoy a las 2am
            // Si no ha llegado a las 2am de hoy, la √∫ltima actualizaci√≥n fue ayer a las 2am
            const ultimaActualizacion = (horaActual >= 2) ? hoy2am : ayer2am;
            
            // La pr√≥xima actualizaci√≥n ser√° ma√±ana a las 2am
            const proximaActualizacion = new Date(ultimaActualizacion);
            proximaActualizacion.setDate(proximaActualizacion.getDate() + 1);
            
            return {
                ultima: ultimaActualizacion,
                proxima: proximaActualizacion
            };
        }

        // Funci√≥n para formatear fecha en espa√±ol
        function formatearFecha(fecha) {
            const opciones = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'America/Bogota'
            };
            
            return fecha.toLocaleDateString('es-CO', opciones);
        }

        // Funci√≥n para calcular tiempo restante hasta la pr√≥xima actualizaci√≥n
        function calcularTiempoRestante(proximaActualizacion) {
            const ahora = new Date();
            const diferencia = proximaActualizacion - ahora;
            
            if (diferencia <= 0) {
                return 'Pr√≥ximamente';
            }
            
            const horas = Math.floor(diferencia / (1000 * 60 * 60));
            const minutos = Math.floor((diferencia % (1000 * 60 * 60)) / (1000 * 60));
            
            if (horas > 0) {
                return `en ${horas}h ${minutos}m`;
            } else {
                return `en ${minutos}m`;
            }
        }

        // Mostrar estado de APIs
        async function mostrarEstadoAPIs() {
            const apiStatus = document.getElementById('apiStatus');
            
            try {
                await verificarSaludAPIs();
                
                // Calcular fechas de actualizaci√≥n
                const fechas = obtenerUltimaActualizacion();
                const ultimaFormateada = formatearFecha(fechas.ultima);
                const proximaFormateada = formatearFecha(fechas.proxima);
                const tiempoRestante = calcularTiempoRestante(fechas.proxima);
                
                apiStatus.innerHTML = `
                    <h3>‚úÖ APIs Conectadas</h3>
                    <p>Bases de datos de Manizales y Dorada disponibles</p>
                    <div class="last-update-info">
                        <p><strong>üìÖ √öltima actualizaci√≥n:</strong> ${ultimaFormateada}</p>
                        <p><strong>‚è∞ Pr√≥xima actualizaci√≥n:</strong> ${proximaFormateada} (${tiempoRestante})</p>
                    </div>
                `;
                apiStatus.style.borderColor = '#10b981';
            } catch (error) {
                apiStatus.innerHTML = `
                    <h3>‚ùå Error de Conexi√≥n</h3>
                    <p>${error.message}</p>
                `;
                apiStatus.style.borderColor = '#ef4444';
            }
        }

        async function iniciarAnalisis() {
            const startTime = performance.now();
            console.log('üöÄ Iniciando an√°lisis...');
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('start-section').style.display = 'none';
            document.getElementById('results-section').style.display = 'none';

            try {
                mostrarInfoBusqueda();
                
                // Debug: Carga de datos
                const dataStartTime = performance.now();
                actualizarProgreso('Conectando con bases de datos...');
                await cargarDatos();
                const dataEndTime = performance.now();
                console.log(`üìä Datos cargados en: ${(dataEndTime - dataStartTime).toFixed(2)}ms`);
                
                // Debug: Procesamiento
                const processStartTime = performance.now();
                actualizarProgreso('Procesando c√≥digos disponibles...');
                procesarCodigosDisponibles();
                const processEndTime = performance.now();
                console.log(`‚öôÔ∏è Procesamiento completado en: ${(processEndTime - processStartTime).toFixed(2)}ms`);
                
                actualizarProgreso('Distribuyendo c√≥digos por sede...');
                setTimeout(() => {
                    mostrarResultados();
                    const totalTime = performance.now() - startTime;
                    console.log(`‚úÖ An√°lisis completo en: ${totalTime.toFixed(2)}ms`);
                }, 300);
            } catch (error) {
                console.error('‚ùå Error en an√°lisis:', error);
                mostrarError('Error al cargar los datos: ' + error.message);
            }
        }

        function actualizarProgreso(mensaje) {
            const loadingText = document.querySelector('.loading p');
            if (loadingText) {
                const timestamp = new Date().toLocaleTimeString();
                loadingText.textContent = `[${timestamp}] ${mensaje}`;
            }
        }

        function mostrarInfoBusqueda() {
            console.log(`üîç Proceso implementado:`);
            console.log(`   1. Tomar todos los c√≥digos internos de ambas sedes y ponerlos en una lista`);
            console.log(`   2. Organizarla de mayor a menor`);
            console.log(`   3. Encontrar a partir de 5,000 los espacios vac√≠os (√∫nicos y sin usar)`);
            console.log(`   4. Presentar los primeros 100 libres para Dorada y los 100 siguientes para Manizales`);
        }

        async function cargarDatos() {
            try {
                await verificarSaludAPIs();
                
                // Debug: Cargar Manizales
                const manizalesStart = performance.now();
                actualizarProgreso('Conectando con base de datos de Manizales...');
                await cargarDatosManizales();
                const manizalesEnd = performance.now();
                console.log(`üè™ Manizales cargado en: ${(manizalesEnd - manizalesStart).toFixed(2)}ms`);
                
                // Debug: Cargar Dorada
                const doradaStart = performance.now();
                actualizarProgreso('Conectando con base de datos de Dorada...');
                await cargarDatosDorada();
                const doradaEnd = performance.now();
                console.log(`üè≠ Dorada cargado en: ${(doradaEnd - doradaStart).toFixed(2)}ms`);
                
                console.log('üìà Resumen de datos:', { 
                    manizales: datosManizales.length, 
                    dorada: datosDorada.length,
                    total: datosManizales.length + datosDorada.length
                });
            } catch (error) {
                throw new Error('No se pudieron cargar los datos: ' + error.message);
            }
        }

        async function cargarDatosManizales() {
            try {
                const jsonData = await obtenerDatosConRetry('manizales');
                datosManizales = procesarDatosProductos(jsonData, 'Manizales');
                console.log(`‚úÖ Manizales cargado: ${datosManizales.length} productos`);
            } catch (error) {
                throw new Error(`Error cargando Manizales: ${error.message}`);
            }
        }

        async function cargarDatosDorada() {
            try {
                const jsonData = await obtenerDatosConRetry('ladorada');
                datosDorada = procesarDatosProductos(jsonData, 'Dorada');
                console.log(`‚úÖ Dorada cargado: ${datosDorada.length} productos`);
            } catch (error) {
                throw new Error(`Error cargando Dorada: ${error.message}`);
            }
        }

        function procesarDatosProductos(jsonData, sede) {
            console.log('üìä Procesando datos de productos desde API JSON...');
            console.log('Estructura de datos recibida:', jsonData);
            
            if (!jsonData || !Array.isArray(jsonData) || jsonData.length === 0) {
                console.warn(`‚ö†Ô∏è Datos vac√≠os o inv√°lidos para ${sede}`);
                return [];
            }
            
            if (typeof jsonData[0] === 'object' && !Array.isArray(jsonData[0])) {
                // Es un array de objetos desde API JSON
                console.log('Procesando formato: Array de objetos (JSON)');
                const productos = jsonData.map(producto => {
                    if (!producto.codigo_interno) { 
                        console.warn(`‚ö†Ô∏è Producto sin c√≥digo interno en ${sede}:`, producto);
                        return null; 
                    }
                    return {
                        codigoInterno: producto.codigo_interno.toString().trim(),
                        sede: sede
                    };
                }).filter(p => p !== null);
                
                console.log(`‚úÖ ${sede}: ${productos.length} productos procesados (formato JSON)`);
                return productos;
            } else {
                // Es un array de arrays desde Excel (formato actual de la API)
                console.log('Procesando formato: Array de arrays (Excel-like)');
                const headers = jsonData[0];
                const dataRows = jsonData.slice(1);
                
                if (!headers || !Array.isArray(headers)) {
                    throw new Error(`Headers inv√°lidos en ${sede}`);
                }
                
                const codigoIndex = headers.findIndex(h => h === 'C√≥digo Interno');
                
                if (codigoIndex === -1) {
                    console.error(`‚ùå Headers disponibles en ${sede}:`, headers);
                    throw new Error(`No se encontr√≥ la columna 'C√≥digo Interno' en ${sede}`);
                }
                
                const productos = dataRows.map((row, index) => {
                    if (!row || !Array.isArray(row)) {
                        console.warn(`‚ö†Ô∏è Fila inv√°lida en ${sede}, √≠ndice ${index}:`, row);
                        return null;
                    }
                    
                    const codigoInterno = row[codigoIndex];
                    
                    if (!codigoInterno) {
                        return null;
                    }
                    
                    return {
                        codigoInterno: codigoInterno.toString().trim(),
                        sede: sede
                    };
                }).filter(p => p !== null);
                
                console.log(`‚úÖ ${sede}: ${productos.length} productos procesados (formato Excel-like)`);
                return productos;
            }
        }

        function procesarCodigosDisponibles() {
            const startTime = performance.now();
            console.log('üîß Iniciando procesamiento de c√≥digos...');
            
            // 1. TOMAR TODOS LOS C√ìDIGOS INTERNOS DE AMBAS SEDES Y PONERLOS EN UNA LISTA
            const todosLosCodigos = new Set();
            
            // Debug: Procesar Manizales
            const manizalesStart = performance.now();
            let codigosValidosManizales = 0;
            for (const producto of datosManizales) {
                if (producto.codigoInterno) {
                    const codigo = producto.codigoInterno.toString().trim();
                    if (codigo && codigo !== 'undefined' && codigo !== 'null') {
                        todosLosCodigos.add(codigo);
                        codigosValidosManizales++;
                    }
                }
            }
            const manizalesEnd = performance.now();
            console.log(`üè™ Procesados ${codigosValidosManizales}/${datosManizales.length} c√≥digos v√°lidos Manizales en: ${(manizalesEnd - manizalesStart).toFixed(2)}ms`);
            
            // Debug: Procesar Dorada
            const doradaStart = performance.now();
            let codigosValidosDorada = 0;
            for (const producto of datosDorada) {
                if (producto.codigoInterno) {
                    const codigo = producto.codigoInterno.toString().trim();
                    if (codigo && codigo !== 'undefined' && codigo !== 'null') {
                        todosLosCodigos.add(codigo);
                        codigosValidosDorada++;
                    }
                }
            }
            const doradaEnd = performance.now();
            console.log(`üè≠ Procesados ${codigosValidosDorada}/${datosDorada.length} c√≥digos v√°lidos Dorada en: ${(doradaEnd - doradaStart).toFixed(2)}ms`);

            console.log(`üìä Total de c√≥digos √∫nicos: ${todosLosCodigos.size}`);

            // 2. ORGANIZARLA DE MAYOR A MENOR
            const ordenarStart = performance.now();
            const codigosOrdenados = Array.from(todosLosCodigos)
                .map(codigo => parseInt(codigo))
                .filter(codigo => !isNaN(codigo) && codigo > 0) // Solo c√≥digos v√°lidos
                .sort((a, b) => b - a); // Ordenar de mayor a menor
            const ordenarEnd = performance.now();
            console.log(`üìä C√≥digos ordenados de mayor a menor: ${codigosOrdenados.length} totales en ${(ordenarEnd - ordenarStart).toFixed(2)}ms`);
            
            // Mostrar rango de c√≥digos
            if (codigosOrdenados.length > 0) {
                console.log(`üìà Rango de c√≥digos: ${codigosOrdenados[codigosOrdenados.length - 1]} - ${codigosOrdenados[0]}`);
            }

            // 3. ENCONTRAR A PARTIR DE 5,000 LOS ESPACIOS VAC√çOS (√öNICOS Y SIN USAR)
            const espaciosStart = performance.now();
            const espaciosLibres = encontrarEspaciosLibresDesde5000(codigosOrdenados, 200); // Solo necesitamos 200 (100 para cada sede)
            const espaciosEnd = performance.now();
            console.log(`üîç Encontrados ${espaciosLibres.length} espacios libres desde 5000 en ${(espaciosEnd - espaciosStart).toFixed(2)}ms`);

            // 4. PRESENTAR LOS PRIMEROS 100 LIBRES PARA DORADA Y LOS 100 SIGUIENTES PARA MANIZALES
            const convertirAString = (codigo) => codigo.toString();
            
            codigosDisponiblesDorada = espaciosLibres.slice(0, 100).map(convertirAString);
            codigosDisponiblesManizales = espaciosLibres.slice(100, 200).map(convertirAString);

            // Crear safezones para mostrar en estad√≠sticas (opcional)
            safezoneManizales = [];
            safezoneDorada = [];

            // Validar que los c√≥digos sean √∫nicos
            validarCodigosUnicos();

            console.log(`üìã Distribuci√≥n de c√≥digos disponibles:`);
            console.log(`   - Dorada: ${codigosDisponiblesDorada.length} c√≥digos (primeros 100)`);
            console.log(`   - Manizales: ${codigosDisponiblesManizales.length} c√≥digos (siguientes 100)`);

            const totalTime = performance.now() - startTime;
            console.log(`‚öôÔ∏è Procesamiento total completado en: ${totalTime.toFixed(2)}ms`);
        }

        function encontrarEspaciosLibresDesde5000(codigosOrdenados, cantidad) {
            const startTime = performance.now();
            const espaciosLibres = [];
            
            // Crear un Set para b√∫squeda m√°s eficiente
            const codigosExistentes = new Set(codigosOrdenados);
            console.log(`üîç Buscando ${cantidad} espacios libres desde c√≥digo 5000...`);
            console.log(`üìä Total de c√≥digos existentes: ${codigosExistentes.size}`);

            // Empezar desde 5000 y buscar espacios libres
            let codigoActual = 5000;
            let iteraciones = 0;
            const maxIteraciones = 100000; // L√≠mite alto para asegurar que encontremos suficientes c√≥digos

            console.log(`üöÄ Iniciando b√∫squeda desde c√≥digo ${codigoActual}`);

            while (espaciosLibres.length < cantidad && iteraciones < maxIteraciones) {
                // Verificar si el c√≥digo actual NO est√° en la lista de c√≥digos existentes
                if (!codigosExistentes.has(codigoActual)) {
                    // El c√≥digo actual est√° libre
                    espaciosLibres.push(codigoActual);
                    
                    // Log cada 25 espacios para monitoreo
                    if (espaciosLibres.length % 25 === 0) {
                        console.log(`‚úÖ ${espaciosLibres.length} espacios libres encontrados (√∫ltimo: ${codigoActual})`);
                    }
                }
                
                codigoActual++;
                iteraciones++;
            }

            const endTime = performance.now();
            console.log(`üîç Encontrados ${espaciosLibres.length} espacios libres en ${(endTime - startTime).toFixed(2)}ms (${iteraciones} iteraciones)`);
            
            if (espaciosLibres.length < cantidad) {
                console.warn(`‚ö†Ô∏è Solo se encontraron ${espaciosLibres.length} espacios libres de ${cantidad} solicitados`);
            } else {
                console.log(`‚úÖ Se encontraron exactamente ${espaciosLibres.length} espacios libres`);
            }

            return espaciosLibres;
        }

        function mostrarResultados() {
            // Actualizar estad√≠sticas
            document.getElementById('total-manizales').textContent = datosManizales.length;
            document.getElementById('total-dorada').textContent = datosDorada.length;
            document.getElementById('safezone-manizales').textContent = safezoneManizales.length;
            document.getElementById('safezone-dorada').textContent = safezoneDorada.length;

            // Actualizar informaci√≥n de √∫ltima actualizaci√≥n en resultados
            const fechas = obtenerUltimaActualizacion();
            const ultimaFormateada = formatearFecha(fechas.ultima);
            const proximaFormateada = formatearFecha(fechas.proxima);
            const tiempoRestante = calcularTiempoRestante(fechas.proxima);
            
            document.getElementById('lastUpdateDateResults').textContent = ultimaFormateada;
            document.getElementById('nextUpdateDateResults').textContent = `${proximaFormateada} (${tiempoRestante})`;

            // Debug: Mostrar informaci√≥n detallada
            console.log('üìä RESUMEN FINAL:');
            console.log(`   - Productos Manizales: ${datosManizales.length}`);
            console.log(`   - Productos Dorada: ${datosDorada.length}`);
            console.log(`   - C√≥digos disponibles Manizales: ${codigosDisponiblesManizales.length}`);
            console.log(`   - C√≥digos disponibles Dorada: ${codigosDisponiblesDorada.length}`);
            console.log(`   - √öltima actualizaci√≥n de datos: ${ultimaFormateada}`);
            
            if (codigosDisponiblesManizales.length > 0) {
                console.log(`   - Primer c√≥digo Manizales: ${codigosDisponiblesManizales[0]}`);
                console.log(`   - √öltimo c√≥digo Manizales: ${codigosDisponiblesManizales[codigosDisponiblesManizales.length - 1]}`);
            }
            
            if (codigosDisponiblesDorada.length > 0) {
                console.log(`   - Primer c√≥digo Dorada: ${codigosDisponiblesDorada[0]}`);
                console.log(`   - √öltimo c√≥digo Dorada: ${codigosDisponiblesDorada[codigosDisponiblesDorada.length - 1]}`);
            }

            // Mostrar tablas
            mostrarTablaCodigos('manizales', codigosDisponiblesManizales);
            mostrarTablaCodigos('dorada', codigosDisponiblesDorada);

            // Mostrar resultados
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results-section').style.display = 'block';

            mostrarAlerta('An√°lisis completado exitosamente', 'success');
        }

        function mostrarTablaCodigos(sede, codigos) {
            const container = document.getElementById(`${sede}-table-container`);
            const sedeNombre = sede === 'manizales' ? 'Manizales' : 'Dorada';

            let html = `
                <table class="codes-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>C√≥digo Disponible</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            codigos.forEach((codigo, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><span class="code-item">${codigo}</span></td>
                        <td>‚úÖ Libre</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function exportarCodigosManizales() {
            exportarCodigos(codigosDisponiblesManizales, 'codigos_disponibles_manizales');
        }

        function exportarCodigosDorada() {
            exportarCodigos(codigosDisponiblesDorada, 'codigos_disponibles_dorada');
        }

        function exportarCodigos(codigos, nombreArchivo) {
            const workbook = XLSX.utils.book_new();
            
            // Crear datos para exportar
            const data = [
                ['#', 'C√≥digo Disponible', 'Estado', 'Fecha de Exportaci√≥n']
            ];

            codigos.forEach((codigo, index) => {
                data.push([
                    index + 1,
                    codigo,
                    'Libre',
                    new Date().toLocaleDateString('es-CO', {timeZone: "America/Bogota"})
                ]);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'C√≥digos Disponibles');
            
            XLSX.writeFile(workbook, `${nombreArchivo}_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            mostrarAlerta(`Archivo ${nombreArchivo} exportado exitosamente`, 'success');
        }

        function reiniciarAnalisis() {
            document.getElementById('start-section').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            
            datosManizales = [];
            datosDorada = [];
            codigosDisponiblesManizales = [];
            codigosDisponiblesDorada = [];
            safezoneManizales = [];
            safezoneDorada = [];
        }

        function mostrarAlerta(mensaje, tipo) {
            const alert = document.getElementById('alert');
            alert.textContent = mensaje;
            alert.className = `alert ${tipo}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function validarCodigosUnicos() {
            console.log('üîç Validando unicidad de c√≥digos...');
            
            const todosLosCodigosDisponibles = [
                ...codigosDisponiblesDorada,
                ...codigosDisponiblesManizales,
                ...safezoneManizales,
                ...safezoneDorada
            ];
            
            const codigosUnicos = new Set(todosLosCodigosDisponibles);
            
            if (codigosUnicos.size !== todosLosCodigosDisponibles.length) {
                console.warn('‚ö†Ô∏è Se encontraron c√≥digos duplicados en los espacios libres');
                const duplicados = todosLosCodigosDisponibles.filter((codigo, index) => 
                    todosLosCodigosDisponibles.indexOf(codigo) !== index
                );
                console.warn('C√≥digos duplicados:', duplicados);
            } else {
                console.log('‚úÖ Todos los c√≥digos disponibles son √∫nicos');
            }
            
            // Verificar que no haya conflictos con c√≥digos existentes
            const todosLosCodigosExistentes = new Set();
            datosManizales.forEach(p => todosLosCodigosExistentes.add(p.codigoInterno));
            datosDorada.forEach(p => todosLosCodigosExistentes.add(p.codigoInterno));
            
            const conflictos = todosLosCodigosDisponibles.filter(codigo => 
                todosLosCodigosExistentes.has(codigo)
            );
            
            if (conflictos.length > 0) {
                console.error('‚ùå CONFLICTO: Los siguientes c√≥digos ya existen:', conflictos);
            } else {
                console.log('‚úÖ No hay conflictos con c√≥digos existentes');
            }
        }

        function mostrarError(mensaje) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('start-section').style.display = 'block';
            mostrarAlerta(mensaje, 'error');
        }

        // Funci√≥n para actualizar el tiempo restante en tiempo real
        function actualizarTiempoRestante() {
            const fechas = obtenerUltimaActualizacion();
            const proximaFormateada = formatearFecha(fechas.proxima);
            const tiempoRestante = calcularTiempoRestante(fechas.proxima);
            
            // Actualizar en la secci√≥n de estado de APIs
            const nextUpdateSpan = document.getElementById('nextUpdateDate');
            if (nextUpdateSpan) {
                nextUpdateSpan.textContent = `${proximaFormateada} (${tiempoRestante})`;
            }
            
            // Actualizar en la secci√≥n de resultados
            const nextUpdateResultsSpan = document.getElementById('nextUpdateDateResults');
            if (nextUpdateResultsSpan) {
                nextUpdateResultsSpan.textContent = `${proximaFormateada} (${tiempoRestante})`;
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando C√≥digos Disponibles API...');
            mostrarEstadoAPIs();
            
            // Actualizar tiempo restante cada minuto
            setInterval(actualizarTiempoRestante, 60000);
        });
    </script>
</body>
</html>

