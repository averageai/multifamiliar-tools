<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector de C√≥digos Duplicados - Multi Sede - APIs JSON</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f0f;
            font-size: 14px;
            line-height: 1.4;
            color: #ffffff;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #1a1a1a;
            min-height: 100vh;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 10px 15px;
            border-bottom: 3px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .api-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .logo {
            width: 45px;
            height: 45px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
        }

        .header-text {
            flex: 1;
            min-width: 200px;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.8;
        }

        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 13px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .back-btn:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .back-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .content {
            padding: 15px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .start-section {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .start-section h2 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .start-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .start-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .results {
            display: none;
        }

        .stats-bar {
            display: flex;
            gap: 15px;
            background: #2a2a2a;
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 16px;
            font-weight: bold;
            color: #1070d1;
        }

        .stat-label {
            font-size: 10px;
            color: #a0a0a0;
            text-transform: uppercase;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-header {
            background: #2c3e50;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 11px;
            border-radius: 3px;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .table-container {
            background: #1a1a1a;
            border: 1px solid #333;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 0 0 8px 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background: #2a2a2a;
            padding: 6px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 10;
            color: #ffffff;
        }

        td {
            padding: 4px 8px;
            border-bottom: 1px solid #333;
            color: #ffffff;
        }

        tr:hover {
            background: #2a2a2a;
        }

        .code {
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            color: #2c3e50;
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 11px;
        }

        .code-libre {
            font-family: 'Courier New', monospace;
            background: #1e3a2e;
            color: #4ade80;
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: bold;
        }

        .duplicate-badge {
            background: #dc3545;
            color: #ffffff;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .sede-badge {
            background: #3498db;
            color: #ffffff;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin: 0 2px;
        }

        .alert {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            border-left: 3px solid #bee5eb;
            font-size: 12px;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .footer {
            background: #2c3e50;
            color: #a0a0a0;
            text-align: center;
            padding: 15px;
            font-size: 12px;
            margin-top: 30px;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üîç</div>
            <div class="header-text">
                <h1>Detector de C√≥digos Duplicados</h1>
                <p>An√°lisis de productos con c√≥digos internos repetidos entre sedes</p>
            </div>
                         <div class="api-badge">APIs JSON</div>
            <a href="index.html" class="back-btn">üè† Volver al Hub</a>
        </div>

        <div class="content">
            <div class="start-section" id="startSection">
                <h2>üîç Detector de Duplicados Multi-Sede</h2>
                <p>Esta herramienta analiza las bases de datos de Manizales y Dorada para encontrar productos con c√≥digos internos duplicados.</p>
                <p><strong>Funcionalidad:</strong> Compara c√≥digos internos entre sedes y genera reportes de duplicados.</p>
                <div id="apiStatus" style="margin: 15px 0; padding: 10px; border-radius: 6px; background: #1a1a1a; border: 1px solid #333;">
                    <span>üîÑ Verificando conectividad de APIs...</span>
                </div>
                <button class="start-btn" onclick="iniciarAnalisis()">üöÄ Iniciar An√°lisis</button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analizando bases de datos...</p>
                <p id="loadingDetail">Conectando con sedes...</p>
            </div>

            <div class="results" id="results">
                <div class="stats-bar" id="statsBar">
                    <!-- Stats aqu√≠ -->
                </div>

                <div class="section">
                    <div class="section-header">
                        <span>üìã Productos con C√≥digos Duplicados</span>
                        <div class="action-buttons">
                            <button class="btn" onclick="exportarDuplicados()">üìä Exportar Duplicados</button>
                            <button class="btn btn-warning" onclick="exportarResumen()">üìã Resumen Ejecutivo</button>
                            <button class="btn btn-danger" onclick="reiniciarAnalisis()">üîÑ Reiniciar</button>
                        </div>
                    </div>
                    <div class="table-container" id="duplicatesContainer">
                        <!-- Tabla duplicados aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Desarrollado por Humanos + IA en <a href="https://ai.average.lat" target="_blank">average</a></p>
        </div>
    </div>

    <script>
        let datosManizales = [];
        let datosDorada = [];
        let duplicados = [];
        let estadisticas = {};

        function actualizarProgreso(mensaje) {
            const detailElement = document.getElementById('loadingDetail');
            if (detailElement) {
                detailElement.textContent = mensaje;
            }
        }

        async function iniciarAnalisis() {
            console.log('üöÄ Iniciando an√°lisis de duplicados...');
            
            // Ocultar secci√≥n de inicio y mostrar loading
            document.getElementById('startSection').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            try {
                // Cargar datos de Manizales
                actualizarProgreso('Cargando base de datos Manizales...');
                await cargarDatosManizales();
                
                // Cargar datos de Dorada
                actualizarProgreso('Cargando base de datos Dorada...');
                await cargarDatosDorada();
                
                // Analizar duplicados
                actualizarProgreso('Analizando c√≥digos duplicados...');
                analizarDuplicados();
                
                // Mostrar resultados
                actualizarProgreso('Generando reportes...');
                setTimeout(() => {
                    mostrarResultados();
                    document.getElementById('loading').style.display = 'none';
                }, 300);
                
            } catch (error) {
                console.error('Error en an√°lisis:', error);
                mostrarError('Error en an√°lisis: ' + error.message);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('startSection').style.display = 'block';
            }
        }

        async function cargarDatosManizales() {
            try {
                // Verificar salud de APIs
                await verificarSaludAPIs();
                
                actualizarProgreso('Conectando con base de datos de Manizales...');
                const apiData = await obtenerDatosConRetry('manizales');
                
                if (!apiData.success) {
                    throw new Error(`Error obteniendo datos de Manizales: ${apiData.message || 'Datos no disponibles'}`);
                }
                
                const jsonData = apiData.data;
                console.log(`üìä Datos obtenidos de Manizales:`, apiData.count, 'productos');
                
                datosManizales = procesarDatosSede(jsonData, 'Manizales');
                console.log(`‚úÖ Manizales cargado: ${datosManizales.length} productos`);
            } catch (error) {
                console.error('Error cargando Manizales:', error);
                throw new Error(`No se pudo cargar la base de datos de Manizales: ${error.message}`);
            }
        }

        async function cargarDatosDorada() {
            try {
                // Verificar salud de APIs
                await verificarSaludAPIs();
                
                actualizarProgreso('Conectando con base de datos de Dorada...');
                const apiData = await obtenerDatosConRetry('ladorada');
                
                if (!apiData.success) {
                    throw new Error(`Error obteniendo datos de Dorada: ${apiData.message || 'Datos no disponibles'}`);
                }
                
                const jsonData = apiData.data;
                console.log(`üìä Datos obtenidos de Dorada:`, apiData.count, 'productos');
                
                datosDorada = procesarDatosSede(jsonData, 'Dorada');
                console.log(`‚úÖ Dorada cargado: ${datosDorada.length} productos`);
            } catch (error) {
                console.error('Error cargando Dorada:', error);
                throw new Error(`No se pudo cargar la base de datos de Dorada: ${error.message}`);
            }
        }

        function procesarDatosSede(jsonData, sede) {
            console.log('üìä Procesando datos de productos desde API JSON...');
            console.log('Estructura de datos recibida:', jsonData);
            
            if (jsonData && jsonData.length > 0 && typeof jsonData[0] === 'object' && !Array.isArray(jsonData[0])) {
                // Es un array de objetos desde API JSON
                const productos = jsonData.map(producto => {
                    const codigoInterno = producto.codigo_interno || producto.codigoInterno || '';
                    const nombre = producto.nombre || producto.nombre_producto || '';
                    
                    if (!codigoInterno || !nombre) {
                        return null;
                    }
                    
                    return {
                        codigoInterno: codigoInterno.toString().trim(),
                        nombre: nombre.trim(),
                        sede: sede
                    };
                }).filter(p => p !== null);
                
                console.log(`‚úÖ Procesados ${productos.length} productos de ${sede}`);
                return productos;
            } else {
                // Es un array de arrays desde Excel (mantener compatibilidad)
                const headers = jsonData[0];
                const dataRows = jsonData.slice(1);
                
                const codigoIndex = headers.findIndex(h => h === 'C√≥digo Interno');
                const nombreIndex = headers.findIndex(h => h === 'Nombre');
                
                if (codigoIndex === -1 || nombreIndex === -1) {
                    throw new Error(`No se encontraron las columnas requeridas en ${sede}`);
                }
                
                const productos = dataRows.map((row, index) => {
                    const codigoInterno = row[codigoIndex];
                    const nombre = row[nombreIndex];
                    
                    if (!codigoInterno || !nombre) {
                        return null;
                    }
                    
                    return {
                        codigoInterno: codigoInterno.toString().trim(),
                        nombre: nombre.trim(),
                        sede: sede
                    };
                }).filter(p => p !== null);
                
                console.log(`‚úÖ Procesados ${productos.length} productos de ${sede}`);
                return productos;
            }
        }

        function analizarDuplicados() {
            const codigosManizales = new Set(datosManizales.map(p => p.codigoInterno));
            const codigosDorada = new Set(datosDorada.map(p => p.codigoInterno));
            
            // Encontrar c√≥digos que est√°n en ambas sedes
            const codigosDuplicados = new Set();
            for (const codigo of codigosManizales) {
                if (codigosDorada.has(codigo)) {
                    codigosDuplicados.add(codigo);
                }
            }
            
            // Crear lista de duplicados con informaci√≥n completa
            duplicados = [];
            for (const codigo of codigosDuplicados) {
                const productoManizales = datosManizales.find(p => p.codigoInterno === codigo);
                const productoDorada = datosDorada.find(p => p.codigoInterno === codigo);
                
                duplicados.push({
                    codigoInterno: codigo,
                    manizales: productoManizales,
                    dorada: productoDorada
                });
            }
            
            // Calcular estad√≠sticas
            estadisticas = {
                totalManizales: datosManizales.length,
                totalDorada: datosDorada.length,
                duplicados: duplicados.length,
                unicosManizales: datosManizales.length - duplicados.length,
                unicosDorada: datosDorada.length - duplicados.length
            };
            
            console.log(`‚úÖ An√°lisis completado: ${duplicados.length} duplicados encontrados`);
        }

        function encontrarProximoCodigoLibre(codigoDuplicado) {
            // Obtener todos los c√≥digos existentes en ambas sedes
            const todosLosCodigos = new Set([
                ...datosManizales.map(p => p.codigoInterno),
                ...datosDorada.map(p => p.codigoInterno)
            ]);
            
            // Extraer el patr√≥n del c√≥digo duplicado (asumiendo que es num√©rico)
            const codigoNumerico = parseInt(codigoDuplicado);
            if (isNaN(codigoNumerico)) {
                return 'N/A'; // Si no es num√©rico, no podemos sugerir
            }
            
            // Buscar el pr√≥ximo c√≥digo libre empezando desde el c√≥digo duplicado + 1
            let proximoCodigo = codigoNumerico + 1;
            const maxIntentos = 1000; // L√≠mite para evitar bucles infinitos
            let intentos = 0;
            
            while (intentos < maxIntentos) {
                const codigoString = proximoCodigo.toString();
                
                // Verificar si este c√≥digo ya existe
                if (!todosLosCodigos.has(codigoString)) {
                    return codigoString;
                }
                
                proximoCodigo++;
                intentos++;
            }
            
            // Si no encontramos uno cercano, buscar en un rango m√°s amplio
            for (let i = 1; i <= 1000; i++) {
                const codigoString = i.toString();
                if (!todosLosCodigos.has(codigoString)) {
                    return codigoString;
                }
            }
            
            return 'No disponible';
        }

        function mostrarResultados() {
            // Mostrar estad√≠sticas
            document.getElementById('statsBar').innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${estadisticas.totalManizales}</div>
                    <div class="stat-label">Manizales</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${estadisticas.totalDorada}</div>
                    <div class="stat-label">Dorada</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${estadisticas.duplicados}</div>
                    <div class="stat-label">Duplicados</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${estadisticas.unicosManizales}</div>
                    <div class="stat-label">√önicos MZ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${estadisticas.unicosDorada}</div>
                    <div class="stat-label">√önicos DR</div>
                </div>
            `;
            
            // Mostrar tabla de duplicados
            mostrarTablaDuplicados();
            
            document.getElementById('results').style.display = 'block';
        }

        function mostrarTablaDuplicados() {
            const container = document.getElementById('duplicatesContainer');
            
            if (duplicados.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ Sin duplicados encontrados</strong> - Todos los c√≥digos internos son √∫nicos entre las sedes.
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>C√≥digo Interno</th>
                            <th>Producto Manizales</th>
                            <th>Producto Dorada</th>
                            <th>Estado</th>
                            <th>Pr√≥ximo C√≥digo Libre (Dorada)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            duplicados.forEach((duplicado, index) => {
                const nombresIguales = duplicado.manizales.nombre.toLowerCase() === duplicado.dorada.nombre.toLowerCase();
                const estado = nombresIguales ? 'Mismo nombre' : 'Nombres diferentes';
                const estadoClass = nombresIguales ? 'duplicate-badge' : 'sede-badge';
                
                // Encontrar pr√≥ximo c√≥digo libre para Dorada
                const proximoCodigoLibre = encontrarProximoCodigoLibre(duplicado.codigoInterno);
                
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><span class="code">${duplicado.codigoInterno}</span></td>
                        <td>${duplicado.manizales.nombre}</td>
                        <td>${duplicado.dorada.nombre}</td>
                        <td><span class="${estadoClass}">${estado}</span></td>
                        <td><span class="code-libre">${proximoCodigoLibre}</span></td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        function exportarDuplicados() {
            if (duplicados.length === 0) {
                mostrarAlerta('‚ö†Ô∏è No hay duplicados para exportar', 'warning');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            const data = [];
            data.push(['REPORTE DE C√ìDIGOS DUPLICADOS - MULTI SEDE', '', '', '', '']);
            data.push(['Fecha:', new Date().toLocaleDateString(), '', '', '']);
            data.push(['Hora:', new Date().toLocaleTimeString(), '', '', '']);
            data.push(['', '', '', '', '']);
            data.push(['#', 'C√≥digo Interno', 'Producto Manizales', 'Producto Dorada', 'Estado', 'Pr√≥ximo C√≥digo Libre']);
            
            duplicados.forEach((duplicado, index) => {
                const nombresIguales = duplicado.manizales.nombre.toLowerCase() === duplicado.dorada.nombre.toLowerCase();
                const estado = nombresIguales ? 'Mismo nombre' : 'Nombres diferentes';
                const proximoCodigoLibre = encontrarProximoCodigoLibre(duplicado.codigoInterno);
                
                data.push([
                    index + 1,
                    duplicado.codigoInterno,
                    duplicado.manizales.nombre,
                    duplicado.dorada.nombre,
                    estado,
                    proximoCodigoLibre
                ]);
            });
            
            data.push(['', '', '', '', '']);
            data.push(['RESUMEN', '', '', '', '']);
            data.push(['Total Manizales:', estadisticas.totalManizales, '', '', '']);
            data.push(['Total Dorada:', estadisticas.totalDorada, '', '', '']);
            data.push(['Duplicados encontrados:', estadisticas.duplicados, '', '', '']);
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Duplicados');
            
            const fecha = new Date().toISOString().slice(0,10);
            XLSX.writeFile(wb, `codigos_duplicados_${fecha}.xlsx`);
            mostrarAlerta('‚úÖ Reporte de duplicados exportado', 'success');
        }

        function exportarResumen() {
            const wb = XLSX.utils.book_new();
            
            const data = [];
            data.push(['RESUMEN EJECUTIVO - AN√ÅLISIS DE DUPLICADOS', '', '', '']);
            data.push(['Fecha:', new Date().toLocaleDateString(), '', '']);
            data.push(['Hora:', new Date().toLocaleTimeString(), '', '']);
            data.push(['', '', '', '']);
            data.push(['M√©trica', 'Valor', 'Descripci√≥n', '']);
            data.push(['Total Manizales', estadisticas.totalManizales, 'Productos √∫nicos en Manizales', '']);
            data.push(['Total Dorada', estadisticas.totalDorada, 'Productos √∫nicos en Dorada', '']);
            data.push(['Duplicados', estadisticas.duplicados, 'C√≥digos presentes en ambas sedes', '']);
            data.push(['√önicos Manizales', estadisticas.unicosManizales, 'Solo en Manizales', '']);
            data.push(['√önicos Dorada', estadisticas.unicosDorada, 'Solo en Dorada', '']);
            data.push(['', '', '', '']);
            data.push(['TOP 10 DUPLICADOS', '', '', '']);
            data.push(['#', 'C√≥digo', 'Nombre Manizales', 'Nombre Dorada']);
            
            duplicados.slice(0, 10).forEach((duplicado, index) => {
                data.push([
                    index + 1,
                    duplicado.codigoInterno,
                    duplicado.manizales.nombre,
                    duplicado.dorada.nombre
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Resumen');
            
            const fecha = new Date().toISOString().slice(0,10);
            XLSX.writeFile(wb, `resumen_duplicados_${fecha}.xlsx`);
            mostrarAlerta('‚úÖ Resumen ejecutivo exportado', 'success');
        }

        function reiniciarAnalisis() {
            if (confirm('¬øEst√°s seguro de que quieres reiniciar el an√°lisis?')) {
                datosManizales = [];
                datosDorada = [];
                duplicados = [];
                estadisticas = {};
                
                document.getElementById('results').style.display = 'none';
                document.getElementById('startSection').style.display = 'block';
                
                mostrarAlerta('üîÑ An√°lisis reiniciado', 'success');
            }
        }

        function mostrarAlerta(mensaje, tipo) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo}`;
            alertDiv.innerHTML = mensaje;
            
            const content = document.querySelector('.content');
            const firstChild = content.firstElementChild;
            content.insertBefore(alertDiv, firstChild.nextSibling);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 4000);
        }

        function mostrarError(mensaje) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.innerHTML = `<strong>Error:</strong> ${mensaje}`;
            document.querySelector('.content').appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 8000);
        }

        // ========================================
        // üîå FUNCIONES API JSON
        // ========================================

        const sedesConfig = {
            manizales: {
                nombre: 'Manizales',
                apiSede: 'manizales',
                apiUrl: 'https://cristaleria.average.lat/api/products-json',
                healthUrl: 'https://cristaleria.average.lat/api/health-db',
                icon: 'üè™',
                color: '#28a745'
            },
            dorada: {
                nombre: 'Dorada',
                apiSede: 'ladorada',
                apiUrl: 'https://cristaleria.average.lat/api/products-json',
                healthUrl: 'https://cristaleria.average.lat/api/health-db',
                icon: 'üè¨',
                color: '#3498db'
            }
        };

        async function verificarSaludAPIs() {
            try {
                actualizarProgreso('Verificando conectividad de APIs...');
                const response = await fetch('https://cristaleria.average.lat/api/health-db');
                const data = await response.json();
                
                if (data.status !== 'healthy') {
                    throw new Error('APIs no disponibles: ' + (data.message || 'Error de conectividad'));
                }
                
                console.log('‚úÖ APIs saludables:', data.summary);
                return true;
            } catch (error) {
                console.error('‚ùå Error verificando APIs:', error);
                throw new Error('No se pudo conectar con las APIs: ' + error.message);
            }
        }



        async function obtenerDatosConRetry(sede, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 segundos
                    
                    const response = await fetch(`https://cristaleria.average.lat/api/products-json?sede=${sede}`, {
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    if (!data.success) {
                        throw new Error('Error en API: ' + (data.message || 'Error desconocido'));
                    }
                    
                    return data;
                } catch (error) {
                    console.error(`Intento ${i + 1} fall√≥:`, error.message);
                    
                    if (error.name === 'AbortError') {
                        throw new Error('Timeout: La API tard√≥ m√°s de 60 segundos en responder');
                    }
                    
                    if (i === maxRetries - 1) {
                        throw new Error(`Fall√≥ despu√©s de ${maxRetries} intentos: ${error.message}`);
                    }
                    
                    // Esperar antes del siguiente intento (backoff exponencial)
                    await new Promise(resolve => setTimeout(resolve, 2000 * (i + 1)));
                }
            }
        }

        function mostrarEstadoAPIs() {
            const statusDiv = document.getElementById('apiStatus');
            
            verificarSaludAPIs()
                .then(() => {
                    statusDiv.innerHTML = '<span style="color: #28a745;">‚úÖ APIs conectadas y funcionando</span>';
                    statusDiv.style.borderColor = '#28a745';
                })
                .catch((error) => {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå Error de conexi√≥n: ${error.message}</span>`;
                    statusDiv.style.borderColor = '#dc3545';
                });
        }

        // Inicializar estado de APIs al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando Duplicados API - Versi√≥n con APIs JSON');
            mostrarEstadoAPIs();
            
            // Verificar estado cada 30 segundos
            setInterval(mostrarEstadoAPIs, 30000);
        });
    </script>
</body>
</html> 